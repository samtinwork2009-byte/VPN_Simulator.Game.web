<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網絡守護者 - VPN建造模擬遊戲</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code 库 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0a0e17;
            --panel-bg: rgba(30, 41, 59, 0.9);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(30, 58, 138, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(30, 58, 138, 0.15) 0%, transparent 20%);
        }
        
        .page {
            display: none;
            position: relative;
            min-height: 100vh;
            padding: 15px;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* 導航按鈕 */
        .nav-buttons {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }
        
        .nav-btn {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .nav-btn:hover {
            background: linear-gradient(to right, var(--primary-dark), #1e3a8a);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
        }
        
        .nav-btn.secondary {
            background: linear-gradient(to right, #475569, #334155);
        }
        
        /* 首頁樣式 */
        .hero {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 85vh;
            text-align: center;
            padding: 30px 15px;
        }
        
        .logo-container {
            margin-bottom: 30px;
            position: relative;
        }
        
        .logo-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.7);
            animation: pulse 2s infinite;
        }
        
        .logo-text {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary-light), var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .logo-subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-bottom: 25px;
            max-width: 600px;
        }
        
        .game-description {
            max-width: 800px;
            margin: 0 auto 40px;
            font-size: 1.05rem;
            color: #cbd5e1;
            line-height: 1.7;
            background-color: rgba(15, 23, 42, 0.7);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin-top: 30px;
        }
        
        .mode-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .mode-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }
        
        .mode-icon {
            font-size: 2.5rem;
            color: var(--primary-light);
            margin-bottom: 15px;
        }
        
        .mode-title {
            font-size: 1.6rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .mode-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            flex-grow: 1;
            font-size: 0.95rem;
        }
        
        /* 遊戲頁面通用樣式 */
        .game-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border-bottom: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .game-title {
            font-size: 1.8rem;
            color: var(--primary-light);
        }
        
        .game-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1200px) {
            .game-area {
                grid-template-columns: 250px 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background-color: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        
        .panel-title {
            color: #38bdf8;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .main-game {
            min-height: 550px;
            position: relative;
            overflow: hidden;
        }
        
        .btn {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            width: 100%;
            margin-top: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: linear-gradient(to right, var(--primary-dark), #1e3a8a);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(59, 130, 246, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #475569, #334155);
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #059669);
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning), #d97706);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #dc2626);
        }
        
        .progress-container {
            background-color: #334155;
            border-radius: 8px;
            height: 18px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(to right, var(--success), var(--primary));
            height: 100%;
            width: 0%;
            transition: width 0.8s ease;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        /* 簡化版關卡列表 */
        .compact-level-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .compact-level-item {
            padding: 12px 15px;
            background-color: #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .compact-level-item:hover {
            background-color: #475569;
        }
        
        .compact-level-item.active {
            background-color: rgba(30, 58, 138, 0.8);
            border-left: 4px solid var(--primary-light);
        }
        
        .compact-level-item.completed {
            border-left: 4px solid var(--success);
        }
        
        .compact-level-number {
            background-color: #1e293b;
            color: var(--text-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .compact-level-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background-color: rgba(30, 41, 59, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background-color: #1e293b;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            background-color: #334155;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-light);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* 網絡模擬效果 */
        .network-simulation {
            position: relative;
            height: 320px;
            background-color: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .network-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            text-align: center;
            padding: 8px;
        }
        
        .client-node {
            background: linear-gradient(135deg, var(--success), #059669);
            top: 60px;
            left: 60px;
        }
        
        .server-node {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            top: 60px;
            right: 60px;
        }
        
        .vpn-server-node {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            top: 200px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .network-line {
            position: absolute;
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            height: 4px;
            transform-origin: 0 0;
            z-index: 1;
            border-radius: 2px;
        }
        
        .data-packet {
            position: absolute;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--warning), #d97706);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            animation: pulse 2s infinite;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }
        
        .tunnel-visual {
            position: absolute;
            border: 3px dashed #64748b;
            border-radius: 10px;
            background-color: rgba(59, 130, 246, 0.1);
            z-index: 0;
        }
        
        .component {
            background-color: #475569;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: move;
            border: 2px dashed #64748b;
            text-align: center;
            transition: all 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .component:hover {
            border-color: var(--primary);
            background-color: #4b5563;
            transform: translateY(-3px);
        }
        
        .drop-zone {
            min-height: 200px;
            border: 3px dashed #64748b;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .drop-zone.active {
            border-color: var(--primary);
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .message-log {
            background-color: #0f172a;
            border-radius: 8px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
        }
        
        .log-time {
            color: var(--text-secondary);
            min-width: 75px;
            font-size: 0.85rem;
        }
        
        .log-info {
            color: var(--primary-light);
        }
        
        .log-success {
            color: var(--success);
        }
        
        .log-warning {
            color: var(--warning);
        }
        
        .log-error {
            color: var(--danger);
        }
        
        .tutorial-text {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            line-height: 1.7;
        }
        
        .game-screen {
            display: none;
        }
        
        .game-screen.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .protocol-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .protocol-options {
                grid-template-columns: 1fr;
            }
        }
        
        .protocol-option {
            background-color: #334155;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .protocol-option:hover {
            background-color: #475569;
            transform: translateY(-5px);
        }
        
        .protocol-option.selected {
            border-color: var(--primary);
            background-color: rgba(30, 58, 138, 0.5);
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.3);
        }
        
        .protocol-icon {
            font-size: 2.2rem;
            color: var(--primary-light);
            margin-bottom: 12px;
        }
        
        .protocol-title {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .protocol-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .toolbox {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .tool-item {
            background-color: #334155;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tool-item:hover {
            background-color: #475569;
            transform: translateY(-3px);
        }
        
        .tool-icon {
            font-size: 1.8rem;
            color: var(--primary-light);
            margin-bottom: 8px;
        }
        
        /* 電腦模擬介面 */
        .computer-simulation {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #475569;
        }
        
        .computer-header {
            background-color: #0f172a;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .computer-screen {
            background-color: #0a0e17;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 300px;
            border: 2px solid var(--border-color);
            font-family: 'Courier New', monospace;
            overflow-y: auto;
            overflow-x: auto;
            word-wrap: break-word;
            word-break: break-all;
        }
        
        .command-line {
            color: var(--success);
            margin-bottom: 10px;
        }
        
        .command-prompt {
            color: var(--primary-light);
        }
        
        .command-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            width: calc(100% - 20px);
            outline: none;
        }
        
        .vpn-config-code {
            background-color: #0f172a;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-top: 15px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .config-line {
            margin-bottom: 5px;
        }
        
        .config-key {
            color: var(--primary-light);
        }
        
        .config-value {
            color: var(--success);
        }
        
        .config-comment {
            color: var(--text-secondary);
        }
        
        /* 自由模式專用樣式 */
        .free-mode-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 600px) {
            .free-mode-controls {
                grid-template-columns: 1fr;
            }
        }
        
        .control-group {
            background-color: #1e293b;
            padding: 15px;
            border-radius: 8px;
        }
        
        .control-title {
            color: var(--primary-light);
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        @media (max-width: 600px) {
            .control-item {
                margin-bottom: 15px;
            }
        }
        
        .control-label {
            display: block;
            margin-bottom: 5px;
            color: #cbd5e1;
        }
        
        .control-input {
            width: 100%;
            background-color: #0f172a;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
        }
        
        .control-select {
            width: 100%;
            background-color: #0f172a;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
        }
        
        /* 教學模式專用樣式 */
        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .tutorial-step {
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tutorial-step:hover {
            background-color: rgba(30, 41, 59, 0.9);
            transform: translateX(5px);
        }
        
        .tutorial-step.active {
            background-color: rgba(30, 58, 138, 0.5);
            border-left: 5px solid var(--primary-light);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .step-number {
            background-color: var(--primary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .step-title {
            font-size: 1.4rem;
            color: var(--text-primary);
        }
        
        .step-content {
            color: var(--text-secondary);
            line-height: 1.6;
            padding-left: 51px; /* 36px + 15px gap */
        }
        
        @media (max-width: 768px) {
            .step-content {
                padding-left: 0;
            }
        }
        
        .knowledge-points {
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--success);
        }
        
        .knowledge-title {
            color: var(--success);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .attack-simulation {
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--danger);
        }
        
        .attack-title {
            color: var(--danger);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        /* 新增功能樣式 */
        .free-mode-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            background-color: #334155;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background-color: #475569;
            border-color: var(--primary);
        }
        
        .preset-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        .share-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .qrcode-container {
            display: none;
            text-align: center;
            margin-top: 15px;
        }
        
        .qrcode-container.active {
            display: block;
        }
        
        .qrcode-canvas {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }
        
        /* 引導樣式 */
        .guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            display: none;
        }
        
        .guide-overlay.active {
            display: block;
        }
        
        .guide-tooltip {
            position: absolute;
            background-color: var(--dark-bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .guide-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .guide-arrow-top {
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent var(--primary) transparent;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .guide-arrow-bottom {
            border-width: 10px 10px 0 10px;
            border-color: var(--primary) transparent transparent transparent;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .guide-content {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .guide-close {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* 問答彈窗樣式 */
        .qa-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none;
        }
        
        .qa-modal-overlay.active {
            display: flex;
        }
        
        .qa-modal {
            background-color: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
        }
        
        .qa-question {
            color: var(--text-primary);
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .qa-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .qa-option {
            background-color: #334155;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .qa-option:hover {
            background-color: #475569;
        }
        
        .qa-option.selected {
            border-color: var(--primary);
            background-color: rgba(30, 58, 138, 0.5);
        }
        
        .qa-option.correct {
            border-color: var(--success);
            background-color: rgba(16, 185, 129, 0.2);
        }
        
        .qa-option.wrong {
            border-color: var(--danger);
            background-color: rgba(239, 68, 68, 0.2);
        }
        
        .qa-explanation {
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .qa-explanation.active {
            display: block;
        }
        
        .qa-result {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .qa-result.correct {
            color: var(--success);
        }
        
        .qa-result.wrong {
            color: var(--danger);
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
            background-color: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
        }
        
        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                grid-template-columns: 1fr;
            }
            
            .toolbox {
                grid-template-columns: 1fr;
            }
            
            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .nav-buttons {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
                justify-content: center;
            }
            
            .hero {
                padding: 15px 10px;
            }
            
            .logo-text {
                font-size: 2.2rem;
            }
            
            .logo-icon {
                font-size: 3rem;
            }
            
            .free-mode-controls {
                grid-template-columns: 1fr;
            }
            
            .tutorial-steps {
                gap: 15px;
            }
            
            .step-content {
                padding-left: 0;
            }
            
            .network-simulation {
                height: 250px;
            }
            
            .network-node {
                width: 60px;
                height: 60px;
                font-size: 0.8rem;
            }
            
            .client-node {
                top: 40px;
                left: 40px;
            }
            
            .server-node {
                top: 40px;
                right: 40px;
            }
            
            .vpn-server-node {
                top: 150px;
            }
            
            .computer-screen {
                padding: 15px;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .game-header {
                padding: 15px;
            }
            
            .panel {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                padding: 12px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .mode-card {
                padding: 15px;
            }
        }
        
        /* Firefox 兼容性修復 */
        @supports (-moz-appearance:none) {
            .btn, .nav-btn {
                background: var(--primary);
            }
            
            .btn:hover, .nav-btn:hover {
                background: var(--primary-dark);
            }
            
            .btn-secondary {
                background: #475569;
            }
            
            .btn-success {
                background: var(--success);
            }
            
            .btn-warning {
                background: var(--warning);
            }
            
            .btn-danger {
                background: var(--danger);
            }
            
            .panel {
                border: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <!-- 全域導航按鈕 -->
    <div class="nav-buttons">
        <button class="nav-btn secondary" id="backBtn"><i class="fas fa-arrow-left"></i> 返回</button>
        <button class="nav-btn" id="homeBtn"><i class="fas fa-home"></i> 主頁</button>
    </div>

    <!-- 引導遮罩 -->
    <div class="guide-overlay" id="guideOverlay"></div>

    <!-- 問答彈窗 -->
    <div class="qa-modal-overlay" id="qaModal">
        <div class="qa-modal">
            <div class="qa-question" id="qaQuestionText"></div>
            <div class="qa-options" id="qaOptions"></div>
            <div class="qa-explanation" id="qaExplanation"></div>
            <button class="btn" id="qaNextBtn" style="display: none;">下一題</button>
            <button class="btn" id="qaCloseBtn">關閉</button>
        </div>
    </div>

    <!-- 首頁 -->
    <div id="homePage" class="page active">
        <div class="container">
            <div class="hero">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h1 class="logo-text">網絡守護者</h1>
                    <div class="logo-subtitle">VPN建造模擬遊戲</div>
                </div>
                
                <div class="game-description">
                    <p>《網絡守護者》是一款專為學習VPN技術設計的模擬遊戲。在這個遊戲中，你將扮演網絡安全工程師，從零開始學習VPN原理，並親手建立安全的虛擬私人網絡。</p>
                    <p>遊戲包含多種模式：教學模式帶你從零開始學習；挑戰模式包含10個漸進式關卡；自由模式讓你隨意實驗；所有模式都整合了模擬測試功能！</p>
                </div>
                
                <div class="mode-selector">
                    <div class="mode-card" id="tutorialMode">
                        <div class="mode-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h3 class="mode-title">教學模式</h3>
                        <p class="mode-description">從零開始學習VPN技術，建立完整知識體系，包含四個教學階段。</p>
                    </div>
                    
                    <div class="mode-card" id="challengeMode">
                        <div class="mode-icon">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <h3 class="mode-title">挑戰模式</h3>
                        <p class="mode-description">10個漸進式關卡，從數據加密到完整VPN部署，掌握實戰技能。</p>
                    </div>
                    
                    <div class="mode-card" id="freeMode">
                        <div class="mode-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <h3 class="mode-title">自由模式</h3>
                        <p class="mode-description">自由實驗各種VPN配置，創建自定義設置，測試不同協議組合。</p>
                    </div>
                </div>
            </div>
            
            <footer>
                <p>網絡守護者 - VPN建造模擬遊戲 | 教育用途 | 學習網絡安全與VPN技術</p>
                <p style="margin-top: 10px; font-size: 0.85rem;">遊戲中所有VPN技術原理基於真實網絡安全知識</p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #64748b;" id="saveStatus"></p>
            </footer>
        </div>
    </div>

    <!-- 教學模式頁面 -->
    <div id="tutorialPage" class="page">
        <div class="container">
            <div class="game-header">
                <div>
                    <h1 class="game-title">教學模式</h1>
                    <p class="game-subtitle">從零開始學習VPN技術，建立完整知識體系</p>
                </div>
                <div style="min-width: 250px;">
                    <div>教學進度: <span id="tutorialProgressText">0%</span></div>
                    <div class="progress-container">
                        <div class="progress-bar" id="tutorialProgressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="game-area">
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-list-ol"></i> 教學階段</h2>
                    <div class="compact-level-list" id="tutorialStepsList">
                        <!-- 教學階段列表將由JavaScript動態生成 -->
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="tutorialKnowledgeScore">0</div>
                            <div class="stat-label">知識掌握</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tutorialPracticeScore">0</div>
                            <div class="stat-label">實踐能力</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tutorialTestScore">0</div>
                            <div class="stat-label">測試得分</div>
                        </div>
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-cogs"></i> 教學控制</h2>
                    <button class="btn btn-secondary" id="prevTutorialStepBtn"><i class="fas fa-arrow-left"></i> 上一步</button>
                    <button class="btn" id="nextTutorialStepBtn"><i class="fas fa-arrow-right"></i> 下一步</button>
                    <button class="btn btn-success" id="tutorialTestBtn" style="margin-top: 15px;"><i class="fas fa-vial"></i> 階段測試</button>
                    <button class="btn btn-warning" id="tutorialQuizBtn" style="margin-top: 15px;"><i class="fas fa-question-circle"></i> 知識問答</button>
                </div>
                
                <div class="panel main-game">
                    <!-- 教學階段1：加密基礎 -->
                    <div id="tutorialStep1Screen" class="game-screen active">
                        <h2 class="panel-title"><i class="fas fa-lock"></i> 教學階段1：加密基礎</h2>
                        
                        <div class="tutorial-text">
                            <p><strong>學習目標</strong>：理解加密的基本概念，掌握對稱加密與非對稱加密的區別，了解常用加密算法的特點。</p>
                            <p><strong>學習時長</strong>：約15分鐘</p>
                        </div>
                        
                        <div class="tutorial-steps">
                            <div class="tutorial-step active" data-step="1.1">
                                <div class="step-header">
                                    <div class="step-number">1</div>
                                    <div class="step-title">什麼是加密？</div>
                                </div>
                                <div class="step-content">
                                    <p>加密是將原始數據（明文）轉換為不可讀格式（密文）的過程，只有擁有正確密鑰的人才能解密並讀取數據。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">核心知識點</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>加密保護數據在傳輸過程中的安全</li>
                                            <li>防止未授權訪問和數據竊取</li>
                                            <li>是VPN技術的基礎安全機制</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="1.2">
                                <div class="step-header">
                                    <div class="step-number">2</div>
                                    <div class="step-title">對稱加密 vs 非對稱加密</div>
                                </div>
                                <div class="step-content">
                                    <p><strong>對稱加密</strong>：使用相同的密鑰進行加密和解密。優點是速度快，缺點是密鑰分發困難。</p>
                                    <p><strong>非對稱加密</strong>：使用公鑰和私鑰對，公鑰加密，私鑰解密。優點是解決了密鑰分發問題，缺點是速度較慢。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">應用場景</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>對稱加密：大量數據加密（如AES）</li>
                                            <li>非對稱加密：密鑰交換、數字簽名（如RSA）</li>
                                            <li>實際VPN中常結合兩者優勢</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="1.3">
                                <div class="step-header">
                                    <div class="step-number">3</div>
                                    <div class="step-title">加密算法比較</div>
                                </div>
                                <div class="step-content">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">AES-256</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">對稱加密標準，安全性高，性能優秀，廣泛用於政府和商業領域。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 95%</div>
                                                <div style="color: var(--warning);">性能: 85%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">RSA-2048</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">非對稱加密算法，用於密鑰交換和數字簽名，安全性基於大數分解難題。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 90%</div>
                                                <div style="color: var(--warning);">性能: 70%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">ChaCha20</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">流加密算法，專為移動設備優化，在低功耗設備上性能優異。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 92%</div>
                                                <div style="color: var(--warning);">性能: 95%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="1.4">
                                <div class="step-header">
                                    <div class="step-number">4</div>
                                    <div class="step-title">加密強度與性能關係</div>
                                </div>
                                <div class="step-content">
                                    <p>加密強度越高，安全性越好，但會對性能產生影響。在實際應用中需要找到安全與性能的平衡點。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">平衡原則</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>敏感數據：優先安全性（如AES-256）</li>
                                            <li>移動設備：考慮性能（如ChaCha20）</li>
                                            <li>實時應用：平衡安全與延遲</li>
                                            <li>合規要求：遵循行業標準</li>
                                        </ul>
                                    </div>
                                    <div class="attack-simulation">
                                        <div class="attack-title">攻擊模擬</div>
                                        <p>如果使用弱加密（如DES），攻擊者可以在短時間內破解加密，截取敏感數據。現代VPN必須使用強加密算法。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模擬測試區域 -->
                        <div class="computer-simulation" style="margin-top: 25px;">
                            <div class="computer-header">
                                <i class="fas fa-terminal" style="color: var(--success); margin-right: 10px;"></i>
                                <span style="font-weight: bold;">加密測試終端</span>
                            </div>
                            <div class="computer-screen" id="tutorial1TestOutput">
                                <div class="command-line"><span class="command-prompt">$</span> 歡迎來到加密測試終端</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "test-aes" 測試AES加密</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "test-rsa" 測試RSA加密</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "compare" 比較加密算法</div>
                                <br>
                                <div class="command-line"><span class="command-prompt">$</span> <input type="text" class="command-input" id="tutorial1CommandInput" placeholder="輸入測試命令..."></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm" id="tutorial1TestAESBtn">
                                    <i class="fas fa-shield-alt"></i> 測試AES加密
                                </button>
                                <button class="btn btn-sm" id="tutorial1TestRSABtn">
                                    <i class="fas fa-key"></i> 測試RSA加密
                                </button>
                                <button class="btn btn-sm" id="tutorial1CompareBtn">
                                    <i class="fas fa-balance-scale"></i> 算法比較
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 教學階段2：隧道建立 -->
                    <div id="tutorialStep2Screen" class="game-screen">
                        <h2 class="panel-title"><i class="fas fa-network-wired"></i> 教學階段2：VPN隧道建立</h2>
                        
                        <div class="tutorial-text">
                            <p><strong>學習目標</strong>：理解VPN隧道工作原理，掌握不同隧道協議的特點，學習建立安全通道的完整流程。</p>
                            <p><strong>學習時長</strong>：約20分鐘</p>
                        </div>
                        
                        <div class="tutorial-steps">
                            <div class="tutorial-step" data-step="2.1">
                                <div class="step-header">
                                    <div class="step-number">1</div>
                                    <div class="step-title">VPN隧道原理</div>
                                </div>
                                <div class="step-content">
                                    <p>VPN隧道是在公共網絡（如互聯網）上建立的私有加密通道，將用戶數據封裝在加密包中通過公共網絡傳輸。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">隧道工作流程</div>
                                        <ol style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>客戶端發起連接請求</li>
                                            <li>建立加密參數協商</li>
                                            <li>創建加密隧道</li>
                                            <li>數據封裝與傳輸</li>
                                            <li>伺服器解密並轉發</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="2.2">
                                <div class="step-header">
                                    <div class="step-number">2</div>
                                    <div class="step-title">封裝與封裝解除</div>
                                </div>
                                <div class="step-content">
                                    <p><strong>封裝</strong>：將原始數據包（包括IP頭和數據）放入新的VPN數據包中，添加VPN頭部信息。</p>
                                    <p><strong>封裝解除</strong>：VPN伺服器接收數據包，移除VPN頭部，恢復原始數據包並轉發到目標地址。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">封裝類型</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>IPsec封裝：提供網絡層保護</li>
                                            <li>SSL/TLS封裝：應用層保護，易穿過防火牆</li>
                                            <li>多重封裝：增強安全性但影響性能</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="2.3">
                                <div class="step-header">
                                    <div class="step-number">3</div>
                                    <div class="step-title">隧道協議作用</div>
                                </div>
                                <div class="step-content">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">PPTP</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">點對點隧道協議，速度最快但安全性低，已發現多個安全漏洞。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">速度: 95%</div>
                                                <div style="color: var(--danger);">安全性: 40%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">L2TP/IPsec</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">二層隧道協議結合IPsec加密，平衡速度與安全性，廣泛兼容。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">速度: 70%</div>
                                                <div style="color: var(--warning);">安全性: 85%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">OpenVPN</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">開源VPN協議，安全性最高，可配置性強，社區支持好。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--danger);">速度: 50%</div>
                                                <div style="color: var(--success);">安全性: 95%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="2.4">
                                <div class="step-header">
                                    <div class="step-number">4</div>
                                    <div class="step-title">安全通道建立流程</div>
                                </div>
                                <div class="step-content">
                                    <p>建立VPN隧道的完整流程包括多個階段，每個階段都有特定的安全機制。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">建立步驟</div>
                                        <ol style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>初始聯繫與協議協商</li>
                                            <li>身份驗證與授權</li>
                                            <li>加密密鑰交換</li>
                                            <li>隧道參數協商</li>
                                            <li>數據傳輸與維護</li>
                                            <li>連接終止與清理</li>
                                        </ol>
                                    </div>
                                    <div class="attack-simulation">
                                        <div class="attack-title">攻擊模擬</div>
                                        <p>攻擊者可能嘗試中間人攻擊，截取握手過程中的密鑰交換信息。使用強加密和證書驗證可以防禦此類攻擊。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模擬測試區域 -->
                        <div class="computer-simulation" style="margin-top: 25px;">
                            <div class="computer-header">
                                <i class="fas fa-network-wired" style="color: var(--primary-light); margin-right: 10px;"></i>
                                <span style="font-weight: bold;">隧道測試終端</span>
                            </div>
                            <div class="computer-screen" id="tutorial2TestOutput">
                                <div class="command-line"><span class="command-prompt">$</span> 歡迎來到隧道測試終端</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "create-tunnel" 建立VPN隧道</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "test-speed" 測試隧道速度</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "simulate-attack" 模擬攻擊</div>
                                <br>
                                <div class="command-line"><span class="command-prompt">$</span> <input type="text" class="command-input" id="tutorial2CommandInput" placeholder="輸入測試命令..."></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm" id="tutorial2CreateTunnelBtn">
                                    <i class="fas fa-link"></i> 建立隧道
                                </button>
                                <button class="btn btn-sm" id="tutorial2TestSpeedBtn">
                                    <i class="fas fa-tachometer-alt"></i> 速度測試
                                </button>
                                <button class="btn btn-sm btn-danger" id="tutorial2SimulateAttackBtn">
                                    <i class="fas fa-bug"></i> 模擬攻擊
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 教學階段3：認證系統 -->
                    <div id="tutorialStep3Screen" class="game-screen">
                        <h2 class="panel-title"><i class="fas fa-user-shield"></i> 教學階段3：認證系統</h2>
                        
                        <div class="tutorial-text">
                            <p><strong>學習目標</strong>：理解身份驗證的重要性，掌握不同認證方式的原理，學習認證系統的設計與管理。</p>
                            <p><strong>學習時長</strong>：約15分鐘</p>
                        </div>
                        
                        <div class="tutorial-steps">
                            <div class="tutorial-step" data-step="3.1">
                                <div class="step-header">
                                    <div class="step-number">1</div>
                                    <div class="step-title">身份驗證重要性</div>
                                </div>
                                <div class="step-content">
                                    <p>身份驗證確保只有授權用戶可以訪問VPN資源，是網絡安全的第一道防線。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">驗證原則</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>你知道什麼（密碼、PIN）</li>
                                            <li>你擁有什麼（令牌、證書）</li>
                                            <li>你是什麼（生物特徵）</li>
                                            <li>你在哪裡（地理位置）</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="3.2">
                                <div class="step-header">
                                    <div class="step-number">2</div>
                                    <div class="step-title">不同認證方式比較</div>
                                </div>
                                <div class="step-content">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">密碼認證</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">最常見的認證方式，簡單易用但容易受到暴力破解和釣魚攻擊。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--warning);">安全性: 60%</div>
                                                <div style="color: var(--success);">易用性: 90%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">證書認證</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">基於數字證書的認證，安全性高但部署和管理複雜。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 85%</div>
                                                <div style="color: var(--danger);">易用性: 50%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">雙因素認證</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">結合兩種不同類型的認證因素，大大增強安全性。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 95%</div>
                                                <div style="color: var(--warning);">易用性: 70%</div>
                                            </div>
                                        </div>
                                        <div style="background-color: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px;">
                                            <h4 style="color: var(--primary-light); margin-bottom: 10px;">生物認證</h4>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">使用指紋、臉部等生物特徵，方便但可能存在隱私問題。</p>
                                            <div style="margin-top: 10px;">
                                                <div style="color: var(--success);">安全性: 90%</div>
                                                <div style="color: var(--success);">易用性: 95%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="3.3">
                                <div class="step-header">
                                    <div class="step-number">3</div>
                                    <div class="step-title">雙因素認證原理</div>
                                </div>
                                <div class="step-content">
                                    <p>雙因素認證要求用戶提供兩種不同類型的認證憑據，通常結合「你知道什麼」和「你擁有什麼」。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">常見組合</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>密碼 + 短信驗證碼</li>
                                            <li>密碼 + 身份驗證器應用（如Google Authenticator）</li>
                                            <li>密碼 + 硬件令牌</li>
                                            <li>證書 + 生物特徵</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="3.4">
                                <div class="step-header">
                                    <div class="step-number">4</div>
                                    <div class="step-title">證書管理基礎</div>
                                </div>
                                <div class="step-content">
                                    <p>數字證書是用於身份驗證的電子文檔，包含公鑰和身份信息，由證書頒發機構（CA）簽名。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">證書生命周期</div>
                                        <ol style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>證書申請與生成</li>
                                            <li>CA驗證與簽發</li>
                                            <li>證書分發與安裝</li>
                                            <li>證書使用與驗證</li>
                                            <li>證書更新或撤銷</li>
                                        </ol>
                                    </div>
                                    <div class="attack-simulation">
                                        <div class="attack-title">攻擊模擬</div>
                                        <p>攻擊者可能嘗試證書欺騙或中間人攻擊，使用有效的證書驗證機制和證書吊銷列表可以防禦此類攻擊。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模擬測試區域 -->
                        <div class="computer-simulation" style="margin-top: 25px;">
                            <div class="computer-header">
                                <i class="fas fa-user-check" style="color: var(--primary-light); margin-right: 10px;"></i>
                                <span style="font-weight: bold;">認證測試終端</span>
                            </div>
                            <div class="computer-screen" id="tutorial3TestOutput">
                                <div class="command-line"><span class="command-prompt">$</span> 歡迎來到認證測試終端</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "test-password" 測試密碼認證</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "test-2fa" 測試雙因素認證</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "brute-force" 模擬暴力破解</div>
                                <br>
                                <div class="command-line"><span class="command-prompt">$</span> <input type="text" class="command-input" id="tutorial3CommandInput" placeholder="輸入測試命令..."></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm" id="tutorial3TestPasswordBtn">
                                    <i class="fas fa-key"></i> 密碼認證測試
                                </button>
                                <button class="btn btn-sm" id="tutorial3Test2FABtn">
                                    <i class="fas fa-mobile-alt"></i> 2FA測試
                                </button>
                                <button class="btn btn-sm btn-danger" id="tutorial3BruteForceBtn">
                                    <i class="fas fa-hammer"></i> 暴力破解模擬
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 教學階段4：安全測試 -->
                    <div id="tutorialStep4Screen" class="game-screen">
                        <h2 class="panel-title"><i class="fas fa-shield-alt"></i> 教學階段4：安全測試</h2>
                        
                        <div class="tutorial-text">
                            <p><strong>學習目標</strong>：掌握VPN安全測試方法，學習檢測和修復常見安全漏洞，建立完整的安全測試流程。</p>
                            <p><strong>學習時長</strong>：約20分鐘</p>
                        </div>
                        
                        <div class="tutorial-steps">
                            <div class="tutorial-step" data-step="4.1">
                                <div class="step-header">
                                    <div class="step-number">1</div>
                                    <div class="step-title">連接完整性檢查</div>
                                </div>
                                <div class="step-content">
                                    <p>確保VPN連接沒有中斷或降級，檢查加密隧道是否完整有效。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">檢查項目</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>隧道建立狀態</li>
                                            <li>加密算法是否生效</li>
                                            <li>密鑰交換完整性</li>
                                            <li>數據包完整性驗證</li>
                                            <li>連接穩定性監測</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="4.2">
                                <div class="step-header">
                                    <div class="step-number">2</div>
                                    <div class="step-title">DNS洩漏測試</div>
                                </div>
                                <div class="step-content">
                                    <p>檢測DNS請求是否通過VPN隧道，防止DNS請求洩露真實IP和瀏覽歷史。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">測試方法</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>標準DNS洩漏測試</li>
                                            <li>擴展DNS洩漏測試</li>
                                            <li>WebRTC DNS洩漏測試</li>
                                            <li>自定義DNS伺服器測試</li>
                                        </ul>
                                    </div>
                                    <div class="attack-simulation">
                                        <div class="attack-title">攻擊模擬</div>
                                        <p>攻擊者可能通過DNS查詢獲取用戶的真實位置和瀏覽習慣，使用VPN內置的DNS保護可以防止此類洩漏。</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="4.3">
                                <div class="step-header">
                                    <div class="step-number">3</div>
                                    <div class="step-title">WebRTC洩漏檢查</div>
                                </div>
                                <div class="step-content">
                                    <p>WebRTC技術可能洩露真實IP地址，即使在使用VPN的情況下。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">防護措施</div>
                                        <ul style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>瀏覽器擴展禁用WebRTC</li>
                                            <li>VPN客戶端內置WebRTC阻擋</li>
                                            <li>防火牆規則阻止STUN請求</li>
                                            <li>定期使用在線工具檢測</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-step" data-step="4.4">
                                <div class="step-header">
                                    <div class="step-number">4</div>
                                    <div class="step-title">終止開關測試</div>
                                </div>
                                <div class="step-content">
                                    <p>終止開關在VPN連接意外斷開時阻止所有網絡流量，防止數據洩漏。</p>
                                    <div class="knowledge-points">
                                        <div class="knowledge-title">測試流程</div>
                                        <ol style="padding-left: 20px; color: var(--text-secondary);">
                                            <li>建立VPN連接</li>
                                            <li>模擬VPN斷開（手動或故障）</li>
                                            <li>檢查網絡流量是否被阻止</li>
                                            <li>驗證重新連接機制</li>
                                            <li>測試應用級終止開關</li>
                                        </ol>
                                    </div>
                                    <div class="attack-simulation">
                                        <div class="attack-title">攻擊模擬</div>
                                        <p>攻擊者可能故意干擾VPN連接，迫使連接斷開以獲取未加密數據。終止開關可以防止此類攻擊。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模擬測試區域 -->
                        <div class="computer-simulation" style="margin-top: 25px;">
                            <div class="computer-header">
                                <i class="fas fa-vial" style="color: var(--warning); margin-right: 10px;"></i>
                                <span style="font-weight: bold;">安全測試終端</span>
                            </div>
                            <div class="computer-screen" id="tutorial4TestOutput">
                                <div class="command-line"><span class="command-prompt">$</span> 歡迎來到安全測試終端</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "dns-leak" 測試DNS洩漏</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "webrtc-test" 測試WebRTC洩漏</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "kill-switch" 測試終止開關</div>
                                <div class="command-line"><span class="command-prompt">$</span> 輸入 "full-test" 運行完整安全測試</div>
                                <br>
                                <div class="command-line"><span class="command-prompt">$</span> <input type="text" class="command-input" id="tutorial4CommandInput" placeholder="輸入測試命令..."></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                <button class="btn btn-sm" id="tutorial4DNSLeakBtn">
                                    <i class="fas fa-search"></i> DNS洩漏測試
                                </button>
                                <button class="btn btn-sm" id="tutorial4WebRTCTestBtn">
                                    <i class="fas fa-globe"></i> WebRTC測試
                                </button>
                                <button class="btn btn-sm" id="tutorial4KillSwitchBtn">
                                    <i class="fas fa-power-off"></i> 終止開關測試
                                </button>
                                <button class="btn btn-sm btn-success" id="tutorial4FullTestBtn">
                                    <i class="fas fa-vial"></i> 完整安全測試
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 教學日誌 -->
                    <div style="margin-top: 20px;">
                        <h3 class="panel-title"><i class="fas fa-clipboard-list"></i> 教學日誌</h3>
                        <div class="message-log" id="tutorialMessageLog">
                            <div class="log-entry"><span class="log-time">[12:00:00]</span> <span class="log-info">教學模式：歡迎來到VPN教學系統！</span></div>
                            <div class="log-entry"><span class="log-time">[12:00:05]</span> <span class="log-info">教學模式：從加密基礎開始你的VPN學習之旅。</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側面板：工具與組件 -->
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-toolbox"></i> 教學工具庫</h2>
                    <div class="component" data-component="encryption">
                        <i class="fas fa-lock" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">加密工具</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">測試不同加密算法</div>
                    </div>
                    <div class="component" data-component="tunnel">
                        <i class="fas fa-network-wired" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">隧道工具</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">建立VPN隧道</div>
                    </div>
                    <div class="component" data-component="authentication">
                        <i class="fas fa-user-shield" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">認證工具</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">測試認證方式</div>
                    </div>
                    <div class="component" data-component="security">
                        <i class="fas fa-shield-alt" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">安全測試</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">檢測安全漏洞</div>
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-info-circle"></i> 當前學習提示</h2>
                    <div id="tutorialHint" style="background-color: #1e293b; padding: 12px; border-radius: 8px; font-size: 0.9rem; color: #cbd5e1; line-height: 1.5;">
                        在加密基礎階段，你需要理解對稱加密與非對稱加密的區別，以及不同加密算法的適用場景。
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-award"></i> 學習成就</h2>
                    <div style="background-color: #1e293b; padding: 12px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-lock" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>加密基礎掌握</span>
                            <div style="margin-left: auto; color: var(--warning);">0%</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-network-wired" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>隧道建立技能</span>
                            <div style="margin-left: auto; color: var(--warning);">0%</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-user-shield" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>認證系統理解</span>
                            <div style="margin-left: auto; color: var(--warning);">0%</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-shield-alt" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>安全測試能力</span>
                            <div style="margin-left: auto; color: var(--warning);">0%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer>
                <p>網絡守護者 - 教學模式 | 當前階段: <span id="footerTutorialStage">加密基礎</span> | 知識掌握: <span id="footerKnowledgeScore">0</span></p>
            </footer>
        </div>
    </div>

    <!-- 挑戰模式遊戲頁 -->
    <div id="challengePage" class="page">
        <div class="container">
            <div class="game-header">
                <div>
                    <h1 class="game-title">挑戰模式 - 關卡 <span id="currentLevelDisplay">1</span></h1>
                    <p class="game-subtitle" id="currentLevelTitle">數據加密基礎</p>
                </div>
                <div style="min-width: 250px;">
                    <div>遊戲進度: <span id="challengeProgressText">10%</span></div>
                    <div class="progress-container">
                        <div class="progress-bar" id="challengeProgressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="game-area">
                <!-- 左側面板：關卡選擇與統計 -->
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-list-ol"></i> 關卡列表</h2>
                    <div class="compact-level-list" id="challengeLevelList">
                        <!-- 挑戰關卡列表將由JavaScript動態生成 -->
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="challengeSecurityScore">20</div>
                            <div class="stat-label">安全性</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="challengeSpeedScore">15</div>
                            <div class="stat-label">速度</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="challengeStabilityScore">10</div>
                            <div class="stat-label">穩定性</div>
                        </div>
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-cogs"></i> 遊戲控制</h2>
                    <button class="btn btn-secondary" id="challengeRestartLevelBtn"><i class="fas fa-redo"></i> 重啟關卡</button>
                    <button class="btn btn-secondary" id="challengeHintBtn"><i class="fas fa-lightbulb"></i> 提示</button>
                    <button class="btn btn-warning" id="challengeTestBtn"><i class="fas fa-vial"></i> 測試連接</button>
                    <button class="btn btn-success" id="challengeSimulateTestBtn" style="margin-top: 15px;"><i class="fas fa-desktop"></i> 模擬測試</button>
                </div>
                
                <!-- 中間主遊戲區 -->
                <div class="panel main-game">
                    <!-- 關卡1屏幕：數據加密基礎 -->
                    <div id="challengeLevel1Screen" class="game-screen active">
                        <h2 class="panel-title"><i class="fas fa-lock"></i> 關卡1：數據加密基礎</h2>
                        <div class="tutorial-text">
                            <p><strong>任務目標</strong>：選擇合適的加密算法保護客戶端與伺服器之間的數據傳輸。</p>
                            <p><strong>成功條件</strong>：成功傳輸數據且加密強度達到80%以上。</p>
                            <p><strong>挑戰要點</strong>：平衡加密強度與性能影響，選擇最適合的加密算法。</p>
                        </div>
                        
                        <div class="network-simulation">
                            <div class="network-node client-node">
                                <i class="fas fa-laptop" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                客戶端
                            </div>
                            <div class="network-node server-node">
                                <i class="fas fa-server" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                伺服器
                            </div>
                            <div id="challengeConnectionLine" class="network-line" style="display:none;"></div>
                            <div id="challengeDataPacket" class="data-packet" style="top: 100px; left: 100px;">
                                <i class="fas fa-envelope"></i>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 class="panel-title" style="font-size: 1.1rem;"><i class="fas fa-key"></i> 加密算法</h3>
                                <div class="component" data-type="aes">
                                    <i class="fas fa-shield-alt" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                                    <div style="font-weight: bold;">AES-256</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">對稱加密，安全性高</div>
                                </div>
                                <div class="component" data-type="rsa">
                                    <i class="fas fa-unlock-alt" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                                    <div style="font-weight: bold;">RSA-2048</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">非對稱加密，密鑰交換</div>
                                </div>
                                <div class="component" data-type="chaCha">
                                    <i class="fas fa-bolt" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                                    <div style="font-weight: bold;">ChaCha20</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">流加密，速度快</div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="panel-title" style="font-size: 1.1rem;"><i class="fas fa-file-contract"></i> 數據包狀態</h3>
                                <div class="drop-zone" id="challengeEncryptionDropZone">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #64748b; margin-bottom: 10px;"></i>
                                    <div>拖放加密算法到此處</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">選擇合適的加密算法保護數據</div>
                                </div>
                                <div style="margin-top: 15px; background-color: #1e293b; padding: 12px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>當前加密:</span>
                                        <span id="challengeCurrentEncryption" style="color: var(--primary-light); font-weight: bold;">無</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>加密強度:</span>
                                        <span id="challengeEncryptionStrength" style="color: var(--success); font-weight: bold;">0%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>性能影響:</span>
                                        <span id="challengePerformanceImpact" style="color: var(--warning); font-weight: bold;">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" id="challengeSendDataBtn" style="margin-top: 20px;">
                            <i class="fas fa-paper-plane"></i> 傳送數據
                        </button>
                        <button class="btn" id="challengeNextLevelBtn" style="margin-top: 15px; display: none;">
                            <i class="fas fa-arrow-right"></i> 前往下一關
                        </button>
                    </div>
                    
                    <!-- 關卡2屏幕：建立VPN隧道 -->
                    <div id="challengeLevel2Screen" class="game-screen">
                        <h2 class="panel-title"><i class="fas fa-network-wired"></i> 關卡2：建立VPN隧道</h2>
                        <div class="tutorial-text">
                            <p><strong>任務目標</strong>：在客戶端與伺服器之間建立安全的VPN隧道。</p>
                            <p><strong>成功條件</strong>：成功建立隧道且安全性達到70%以上。</p>
                            <p><strong>挑戰要點</strong>：根據不同場景需求選擇合適的VPN協議。</p>
                        </div>
                        
                        <div class="network-simulation">
                            <div class="network-node client-node">
                                <i class="fas fa-laptop" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                客戶端
                            </div>
                            <div class="network-node server-node">
                                <i class="fas fa-server" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                目標伺服器
                            </div>
                            <div class="network-node vpn-server-node">
                                <i class="fas fa-shield-alt" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                VPN伺服器
                            </div>
                            <div id="challengeTunnelVisual" class="tunnel-visual" style="display: none;"></div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h3 class="panel-title" style="font-size: 1.1rem;"><i class="fas fa-project-diagram"></i> 選擇VPN協議</h3>
                            <div class="protocol-options">
                                <div class="protocol-option" data-protocol="pptp">
                                    <div class="protocol-icon"><i class="fas fa-tachometer-alt"></i></div>
                                    <div class="protocol-title">PPTP</div>
                                    <div class="protocol-desc">速度最快，但安全性較低。適合對安全性要求不高的場景。</div>
                                </div>
                                <div class="protocol-option" data-protocol="l2tp">
                                    <div class="protocol-icon"><i class="fas fa-balance-scale"></i></div>
                                    <div class="protocol-title">L2TP/IPsec</div>
                                    <div class="protocol-desc">平衡速度與安全性。廣泛兼容，適合大多數用途。</div>
                                </div>
                                <div class="protocol-option" data-protocol="openvpn">
                                    <div class="protocol-icon"><i class="fas fa-shield-alt"></i></div>
                                    <div class="protocol-title">OpenVPN</div>
                                    <div class="protocol-desc">安全性最高，速度較慢。適合處理敏感數據。</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; background-color: #1e293b; padding: 15px; border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">已選擇協議</div>
                                        <div id="challengeSelectedProtocol" style="font-size: 1.3rem; color: var(--primary-light); font-weight: bold;">無</div>
                                    </div>
                                    <button class="btn btn-success" id="challengeCreateTunnelBtn" style="width: auto; padding: 10px 25px;">
                                        <i class="fas fa-link"></i> 建立隧道
                                    </button>
                                </div>
                                <div id="challengeTunnelStatus" style="color: var(--text-secondary); font-size: 0.9rem;">
                                    請選擇一個VPN協議開始建立隧道
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn" id="challengeNextLevelBtn2" style="margin-top: 20px; display: none;">
                            <i class="fas fa-arrow-right"></i> 前往下一關
                        </button>
                    </div>
                    
                    <!-- 更多關卡屏幕可以在此添加 -->
                    
                    <!-- 模擬測試區域（挑戰模式） -->
                    <div class="computer-simulation" style="margin-top: 25px; display: none;" id="challengeSimulationTest">
                        <div class="computer-header">
                            <i class="fas fa-desktop" style="color: var(--primary-light); margin-right: 10px;"></i>
                            <span style="font-weight: bold;">關卡測試終端 - 虛擬環境</span>
                            <div style="margin-left: auto; display: flex; align-items: center;">
                                <div style="width: 12px; height: 12px; background-color: var(--success); border-radius: 50%; margin-right: 5px;"></div>
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">測試模式</span>
                            </div>
                        </div>
                        
                        <div class="computer-screen" id="challengeTestTerminal">
                            <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> 歡迎來到關卡測試環境</div>
                            <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> 在這裡測試你的VPN配置效果</div>
                            <br>
                            <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> <input type="text" class="command-input" id="challengeTestCommandInput" placeholder="輸入測試命令..."></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-sm" id="challengeRunPingTest">
                                <i class="fas fa-network-wired"></i> 測試連線
                            </button>
                            <button class="btn btn-sm" id="challengeRunSpeedTest">
                                <i class="fas fa-tachometer-alt"></i> 速度測試
                            </button>
                            <button class="btn btn-sm" id="challengeCheckIP">
                                <i class="fas fa-globe"></i> 檢查IP
                            </button>
                            <button class="btn btn-sm btn-warning" id="challengeSimulateAttack">
                                <i class="fas fa-bug"></i> 模擬攻擊
                            </button>
                            <button class="btn btn-sm btn-secondary" id="challengeCloseSimulation">
                                <i class="fas fa-times"></i> 關閉測試
                            </button>
                        </div>
                    </div>
                    
                    <!-- 系統日誌 -->
                    <div style="margin-top: 20px;">
                        <h3 class="panel-title"><i class="fas fa-clipboard-list"></i> 系統日誌</h3>
                        <div class="message-log" id="challengeMessageLog">
                            <div class="log-entry"><span class="log-time">[12:00:00]</span> <span class="log-info">挑戰模式：歡迎來到VPN挑戰模式！</span></div>
                            <div class="log-entry"><span class="log-time">[12:00:05]</span> <span class="log-info">挑戰模式：開始關卡1 - 數據加密基礎</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側面板：工具與組件 -->
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-toolbox"></i> VPN組件庫</h2>
                    <div class="component" data-component="encryption">
                        <i class="fas fa-lock" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">加密模組</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">保護數據傳輸安全</div>
                    </div>
                    <div class="component" data-component="authentication">
                        <i class="fas fa-user-shield" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">認證模組</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">驗證用戶身份</div>
                    </div>
                    <div class="component" data-component="tunnel">
                        <i class="fas fa-network-wired" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">隧道協議</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">建立安全通道</div>
                    </div>
                    <div class="component" data-component="firewall">
                        <i class="fas fa-fire-alt" style="font-size: 1.3rem; margin-bottom: 8px; color: var(--primary-light);"></i>
                        <div style="font-weight: bold;">防火牆</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">過濾惡意流量</div>
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-info-circle"></i> 當前關卡提示</h2>
                    <div id="challengeCurrentHint" style="background-color: #1e293b; padding: 12px; border-radius: 8px; font-size: 0.9rem; color: #cbd5e1; line-height: 1.5;">
                        在關卡1中，你需要選擇合適的加密算法來保護數據。AES-256提供了最好的安全性，而ChaCha20則在移動設備上性能更好。
                    </div>
                    
                    <h2 class="panel-title" style="margin-top: 20px;"><i class="fas fa-award"></i> 關卡成就</h2>
                    <div style="background-color: #1e293b; padding: 12px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-star" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>關卡完成度</span>
                            <div style="margin-left: auto; color: var(--warning);">10%</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-shield-alt" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>安全評分</span>
                            <div style="margin-left: auto; color: var(--warning);">20</div>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-tachometer-alt" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>性能評分</span>
                            <div style="margin-left: auto; color: var(--warning);">15</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-check-circle" style="color: var(--warning); margin-right: 10px;"></i>
                            <span>挑戰評級</span>
                            <div style="margin-left: auto; color: var(--warning);">新手</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer>
                <p>網絡守護者 - 挑戰模式 | 當前關卡: <span id="footerChallengeLevel">1</span> | 安全評分: <span id="footerChallengeSecurity">20</span></p>
            </footer>
        </div>
    </div>

    <!-- 自由模式頁面 -->
    <div id="freeModePage" class="page">
        <div class="container">
            <div class="game-header">
                <div>
                    <h1 class="game-title">自由模式</h1>
                    <p class="game-subtitle">自由實驗各種VPN配置與組合</p>
                </div>
            </div>
            
            <div class="game-area">
                <div class="panel" style="grid-column: 1 / span 3;">
                    <h2 class="panel-title"><i class="fas fa-code"></i> VPN配置實驗室</h2>
                    
                    <div class="free-mode-presets">
                        <button class="preset-btn active" data-preset="security">安全優先</button>
                        <button class="preset-btn" data-preset="speed">速度優先</button>
                        <button class="preset-btn" data-preset="mobile">移動設備優化</button>
                        <button class="preset-btn" data-preset="balance">平衡配置</button>
                    </div>
                    
                    <div class="free-mode-controls">
                        <div class="control-group">
                            <div class="control-title"><i class="fas fa-lock"></i> 加密設置</div>
                            <div class="control-item">
                                <label class="control-label">加密算法</label>
                                <select class="control-select" id="freeEncryptionSelect">
                                    <option value="aes-128">AES-128 (較快)</option>
                                    <option value="aes-256" selected>AES-256 (平衡)</option>
                                    <option value="aes-512">AES-512 (最安全)</option>
                                    <option value="chacha20">ChaCha20 (移動優化)</option>
                                    <option value="camellia">Camellia (替代方案)</option>
                                </select>
                            </div>
                            <div class="control-item">
                                <label class="control-label">加密模式</label>
                                <select class="control-select" id="freeEncryptionMode">
                                    <option value="cbc">CBC (密文分組鏈接)</option>
                                    <option value="gcm" selected>GCM (伽羅瓦/計數器模式)</option>
                                    <option value="ctr">CTR (計數器模式)</option>
                                    <option value="ofb">OFB (輸出反饋)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-title"><i class="fas fa-network-wired"></i> 協議設置</div>
                            <div class="control-item">
                                <label class="control-label">VPN協議</label>
                                <select class="control-select" id="freeProtocolSelect">
                                    <option value="openvpn-tcp">OpenVPN (TCP)</option>
                                    <option value="openvpn-udp" selected>OpenVPN (UDP)</option>
                                    <option value="wireguard">WireGuard</option>
                                    <option value="ikev2">IKEv2/IPsec</option>
                                    <option value="l2tp">L2TP/IPsec</option>
                                    <option value="pptp">PPTP</option>
                                </select>
                            </div>
                            <div class="control-item">
                                <label class="control-label">端口號</label>
                                <input type="number" class="control-input" id="freePortInput" value="1194" min="1" max="65535">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-title"><i class="fas fa-user-shield"></i> 認證設置</div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeAuthPassword" checked> 密碼認證
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeAuthCertificate"> 證書認證
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeAuth2FA"> 雙因素認證
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeAuthOTP"> 一次性密碼
                                </label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-title"><i class="fas fa-shield-alt"></i> 安全功能</div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeKillSwitch" checked> 終止開關
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeDNSProtection" checked> DNS保護
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeNoLogs" checked> 無日誌政策
                                </label>
                            </div>
                            <div class="control-item">
                                <label class="control-label">
                                    <input type="checkbox" id="freeIPv6Protection"> IPv6洩漏保護
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-success" id="applyFreeConfig">
                            <i class="fas fa-check"></i> 應用配置
                        </button>
                        <button class="btn btn-warning" id="freeSimulateTestBtn">
                            <i class="fas fa-desktop"></i> 模擬測試
                        </button>
                        <button class="btn" id="generateConfigCode">
                            <i class="fas fa-code"></i> 生成配置代碼
                        </button>
                        <button class="btn btn-secondary" id="resetFreeConfig">
                            <i class="fas fa-redo"></i> 重置配置
                        </button>
                    </div>
                    
                    <!-- 分享配置區 -->
                    <div class="share-section">
                        <button class="btn" id="shareConfigBtn">
                            <i class="fas fa-share-alt"></i> 分享配置
                        </button>
                        <div class="qrcode-container" id="qrcodeContainer">
                            <canvas class="qrcode-canvas" id="qrcodeCanvas"></canvas>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">掃描二維碼獲取配置代碼</p>
                        </div>
                    </div>
                    
                    <!-- 模擬測試區域（自由模式） -->
                    <div class="computer-simulation" style="margin-top: 25px; display: none;" id="freeSimulationTest">
                        <div class="computer-header">
                            <i class="fas fa-flask" style="color: var(--primary-light); margin-right: 10px;"></i>
                            <span style="font-weight: bold;">自由模式測試終端</span>
                            <div style="margin-left: auto; display: flex; align-items: center;">
                                <div style="width: 12px; height: 12px; background-color: var(--success); border-radius: 50%; margin-right: 5px;"></div>
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">實驗模式</span>
                            </div>
                        </div>
                        
                        <div class="computer-screen" id="freeTestTerminal">
                            <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> 歡迎來到自由模式測試環境</div>
                            <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> 在這裡測試你的自定義VPN配置</div>
                            <br>
                            <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> <input type="text" class="command-input" id="freeTestCommandInput" placeholder="輸入測試命令..."></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-sm" id="freeRunPingTest">
                                <i class="fas fa-network-wired"></i> 測試連線
                            </button>
                            <button class="btn btn-sm" id="freeRunSpeedTest">
                                <i class="fas fa-tachometer-alt"></i> 速度測試
                            </button>
                            <button class="btn btn-sm" id="freeCheckIP">
                                <i class="fas fa-globe"></i> 檢查IP
                            </button>
                            <button class="btn btn-sm" id="freeCheckDNS">
                                <i class="fas fa-search"></i> 檢查DNS
                            </button>
                            <button class="btn btn-sm btn-danger" id="freeSimulateAttack">
                                <i class="fas fa-bug"></i> 模擬攻擊
                            </button>
                            <button class="btn btn-sm btn-secondary" id="freeCloseSimulation">
                                <i class="fas fa-times"></i> 關閉測試
                            </button>
                        </div>
                    </div>
                    
                    <div class="computer-simulation" style="margin-top: 25px;">
                        <div class="computer-header">
                            <i class="fas fa-terminal" style="color: var(--success); margin-right: 10px;"></i>
                            <span style="font-weight: bold;">VPN配置終端</span>
                        </div>
                        <div class="computer-screen" id="freeConfigOutput">
                            <div class="command-line"><span class="command-prompt">$</span> 等待配置命令...</div>
                        </div>
                    </div>
                    
                    <div id="freeConfigCodeContainer" style="display: none; margin-top: 20px;">
                        <h3 class="panel-title" style="font-size: 1.1rem;"><i class="fas fa-file-code"></i> 生成的VPN配置文件</h3>
                        <div class="vpn-config-code" id="freeConfigCode">
                            <!-- VPN配置代碼將在此顯示 -->
                        </div>
                        <button class="btn btn-sm" id="copyConfigCode" style="margin-top: 10px; width: auto;">
                            <i class="fas fa-copy"></i> 複製配置代碼
                        </button>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <h3 class="panel-title"><i class="fas fa-clipboard-list"></i> 自由模式日誌</h3>
                        <div class="message-log" id="freeModeLog">
                            <div class="log-entry"><span class="log-time">[12:00:00]</span> <span class="log-info">自由模式：歡迎來到VPN配置實驗室！</span></div>
                            <div class="log-entry"><span class="log-time">[12:00:05]</span> <span class="log-info">自由模式：在這裡你可以自由實驗各種VPN配置。</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer>
                <p>網絡守護者 - 自由模式 | 實驗各種VPN配置組合 | 發現最佳VPN設置</p>
            </footer>
        </div>
    </div>

    <script>
        // 遊戲全局狀態
        const gameState = {
            currentPage: 'homePage',
            previousPage: null,
            pageHistory: ['homePage'],
            
            // 教學模式狀態
            tutorial: {
                currentStep: 1,
                currentStage: 1,
                completedSteps: [],
                knowledgeScore: 0,
                practiceScore: 0,
                testScore: 0,
                progress: 0
            },
            
            // 挑戰模式狀態
            challenge: {
                currentLevel: 1,
                completedLevels: [1],
                securityScore: 20,
                speedScore: 15,
                stabilityScore: 10,
                encryptionType: null,
                protocolType: null,
                progress: 10
            },
            
            // 自由模式狀態
            freeConfig: {
                encryption: 'aes-256',
                encryptionMode: 'gcm',
                protocol: 'openvpn-udp',
                port: 1194,
                authMethods: ['password'],
                features: ['killSwitch', 'dnsProtection', 'noLogs']
            },
            
            // 引導狀態
            guides: {
                tutorial: false,
                challenge: false,
                freeMode: false
            }
        };

        // 問答題庫
        const questionBank = {
            1: [
                {
                    question: "AES-256屬於哪種類型的加密算法？",
                    options: ["對稱加密", "非對稱加密", "哈希算法", "流加密"],
                    answer: 0,
                    explanation: "AES-256是對稱加密算法，使用相同的密鑰進行加密和解密，安全性高且性能優秀。"
                },
                {
                    question: "RSA加密算法的安全性基於什麼數學難題？",
                    options: ["大整數分解", "離散對數", "橢圓曲線", "背包問題"],
                    answer: 0,
                    explanation: "RSA算法的安全性基於大整數分解的數學難題，將兩個大質數相乘容易，但分解其乘積極為困難。"
                },
                {
                    question: "哪種加密算法專為移動設備優化？",
                    options: ["AES-256", "RSA-2048", "ChaCha20", "DES"],
                    answer: 2,
                    explanation: "ChaCha20是流加密算法，專為移動設備和低功耗設備優化，在這些設備上性能表現優異。"
                }
            ],
            2: [
                {
                    question: "哪種VPN協議速度最快但安全性最低？",
                    options: ["OpenVPN", "L2TP/IPsec", "PPTP", "WireGuard"],
                    answer: 2,
                    explanation: "PPTP（點對點隧道協議）速度最快，但已發現多個安全漏洞，不推薦用於敏感數據傳輸。"
                },
                {
                    question: "哪種VPN協議是開源的？",
                    options: ["PPTP", "L2TP/IPsec", "OpenVPN", "IKEv2"],
                    answer: 2,
                    explanation: "OpenVPN是開源VPN協議，具有最高的安全性，社區支持良好，可配置性強。"
                },
                {
                    question: "L2TP通常與哪種加密協議結合使用？",
                    options: ["SSL", "TLS", "IPsec", "SSH"],
                    answer: 2,
                    explanation: "L2TP通常與IPsec結合使用，L2TP提供隧道功能，IPsec提供加密，形成L2TP/IPsec組合。"
                }
            ],
            3: [
                {
                    question: "雙因素認證通常結合哪兩種認證因素？",
                    options: ["密碼+證書", "密碼+短信驗證碼", "指紋+臉部識別", "證書+硬件令牌"],
                    answer: 1,
                    explanation: "雙因素認證通常結合「你知道什麼」（密碼）和「你擁有什麼」（短信驗證碼、身份驗證器）。"
                },
                {
                    question: "哪種認證方式的安全性最高？",
                    options: ["單一密碼", "雙因素認證", "證書認證", "生物特徵"],
                    answer: 1,
                    explanation: "雙因素認證結合兩種不同類型的認證因素，大大增強了安全性，是最安全的認證方式之一。"
                },
                {
                    question: "數字證書由誰簽發？",
                    options: ["用戶自己", "VPN提供商", "證書頒發機構(CA)", "瀏覽器廠商"],
                    answer: 2,
                    explanation: "數字證書由證書頒發機構（CA）簽發，CA負責驗證證書持有者的身份並簽署證書。"
                }
            ],
            4: [
                {
                    question: "DNS洩漏測試的目的是什麼？",
                    options: ["測試VPN速度", "檢測IP地址洩漏", "檢測DNS請求洩漏", "測試加密強度"],
                    answer: 2,
                    explanation: "DNS洩漏測試用於檢測DNS請求是否通過VPN隧道，防止DNS請求洩露真實IP和瀏覽歷史。"
                },
                {
                    question: "終止開關的主要作用是什麼？",
                    options: ["提高VPN速度", "自動選擇最佳伺服器", "VPN斷開時阻止流量", "優化加密算法"],
                    answer: 2,
                    explanation: "終止開關在VPN連接意外斷開時阻止所有網絡流量，防止數據在未加密狀態下洩漏。"
                },
                {
                    question: "WebRTC可能洩露什麼信息？",
                    options: ["VPN密碼", "真實IP地址", "DNS服務器", "加密密鑰"],
                    answer: 1,
                    explanation: "WebRTC技術可能洩露真實IP地址，即使在使用VPN的情況下，需要特別注意防護。"
                }
            ]
        };

        // 預設配置
        const presetConfigs = {
            security: {
                encryption: 'aes-512',
                encryptionMode: 'gcm',
                protocol: 'openvpn-tcp',
                port: 443,
                authMethods: ['password', 'certificate', '2fa'],
                features: ['killSwitch', 'dnsProtection', 'noLogs', 'ipv6Protection']
            },
            speed: {
                encryption: 'aes-128',
                encryptionMode: 'ctr',
                protocol: 'wireguard',
                port: 51820,
                authMethods: ['password'],
                features: ['dnsProtection']
            },
            mobile: {
                encryption: 'chacha20',
                encryptionMode: 'gcm',
                protocol: 'ikev2',
                port: 500,
                authMethods: ['password', 'certificate'],
                features: ['killSwitch', 'dnsProtection']
            },
            balance: {
                encryption: 'aes-256',
                encryptionMode: 'gcm',
                protocol: 'openvpn-udp',
                port: 1194,
                authMethods: ['password', '2fa'],
                features: ['killSwitch', 'dnsProtection', 'noLogs']
            }
        };

        // DOM元素
        const pages = document.querySelectorAll('.page');
        const backBtn = document.getElementById('backBtn');
        const homeBtn = document.getElementById('homeBtn');
        
        // 保存和加載遊戲狀態
        function saveGameState() {
            localStorage.setItem('vpnGameState', JSON.stringify(gameState));
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) {
                saveStatus.textContent = '遊戲進度已保存';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);
            }
        }
        
        function loadGameState() {
            const savedState = localStorage.getItem('vpnGameState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                // 合併保存的狀態，但要保持某些默認值
                Object.assign(gameState, parsedState);
                console.log('遊戲狀態已加載');
                return true;
            }
            return false;
        }
        
        // 頁面切換功能
        function showPage(pageId) {
            // 保存當前頁面狀態
            beforeLeavePage(gameState.currentPage);
            
            // 更新頁面歷史
            if (pageId !== gameState.currentPage) {
                gameState.pageHistory.push(pageId);
                if (gameState.pageHistory.length > 10) {
                    gameState.pageHistory.shift();
                }
            }
            
            // 記錄當前頁面作為上一個頁面
            gameState.previousPage = gameState.currentPage;
            gameState.currentPage = pageId;
            
            // 隱藏所有頁面
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示目標頁面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.scrollTop = 0;
            }
            
            // 更新導航按鈕狀態
            updateNavButtons();
            
            // 根據頁面初始化
            if (pageId === 'tutorialPage') {
                initTutorialPage();
            } else if (pageId === 'challengePage') {
                initChallengePage();
            } else if (pageId === 'freeModePage') {
                initFreeModePage();
            }
            
            // 保存狀態
            saveGameState();
            
            // 顯示引導
            showGuideIfNeeded(pageId);
        }
        
        // 頁面離開前保存狀態
        function beforeLeavePage(pageId) {
            switch(pageId) {
                case 'tutorialPage':
                    // 教學模式狀態已實時保存
                    break;
                case 'challengePage':
                    // 挑戰模式狀態已實時保存
                    break;
                case 'freeModePage':
                    // 自由模式狀態已實時保存
                    break;
            }
        }
        
        // 顯示引導
        function showGuideIfNeeded(pageId) {
            // 檢查是否已顯示過引導
            const guideKey = pageId.replace('Page', '');
            if (gameState.guides[guideKey]) return;
            
            // 延遲顯示引導
            setTimeout(() => {
                switch(pageId) {
                    case 'tutorialPage':
                        showTutorialGuide();
                        gameState.guides.tutorial = true;
                        break;
                    case 'challengePage':
                        showChallengeGuide();
                        gameState.guides.challenge = true;
                        break;
                    case 'freeModePage':
                        showFreeModeGuide();
                        gameState.guides.freeMode = true;
                        break;
                }
                saveGameState();
            }, 500);
        }
        
        // 顯示教學模式引導
        function showTutorialGuide() {
            const nextBtn = document.getElementById('nextTutorialStepBtn');
            if (!nextBtn) return;
            
            const rect = nextBtn.getBoundingClientRect();
            showGuideTooltip(
                '點擊「下一步」按鈕繼續學習下一階段',
                rect.left + rect.width/2,
                rect.top - 10,
                'top'
            );
        }
        
        // 顯示挑戰模式引導
        function showChallengeGuide() {
            const components = document.querySelectorAll('#challengeLevel1Screen .component');
            if (components.length === 0) return;
            
            const firstComp = components[0];
            const rect = firstComp.getBoundingClientRect();
            showGuideTooltip(
                '拖動加密算法到右側放置區域，然後點擊「傳送數據」',
                rect.left + rect.width/2,
                rect.top + rect.height + 10,
                'bottom'
            );
        }
        
        // 顯示自由模式引導
        function showFreeModeGuide() {
            const applyBtn = document.getElementById('applyFreeConfig');
            if (!applyBtn) return;
            
            const rect = applyBtn.getBoundingClientRect();
            showGuideTooltip(
                '調整配置後點擊「應用配置」，然後可以生成配置代碼',
                rect.left + rect.width/2,
                rect.top - 10,
                'top'
            );
        }
        
        // 顯示引導工具提示
        function showGuideTooltip(text, x, y, position = 'top') {
            const overlay = document.getElementById('guideOverlay');
            if (!overlay) return;
            
            // 創建工具提示
            const tooltip = document.createElement('div');
            tooltip.className = 'guide-tooltip';
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            
            // 創建箭頭
            const arrow = document.createElement('div');
            arrow.className = `guide-arrow guide-arrow-${position}`;
            
            // 創建內容
            const content = document.createElement('div');
            content.className = 'guide-content';
            content.textContent = text;
            
            // 創建關閉按鈕
            const closeBtn = document.createElement('button');
            closeBtn.className = 'guide-close';
            closeBtn.textContent = '知道了';
            closeBtn.onclick = () => {
                overlay.classList.remove('active');
                document.body.removeChild(tooltip);
            };
            
            // 組裝工具提示
            tooltip.appendChild(arrow);
            tooltip.appendChild(content);
            tooltip.appendChild(closeBtn);
            
            // 添加到頁面
            overlay.classList.add('active');
            document.body.appendChild(tooltip);
            
            // 點擊遮罩關閉
            overlay.onclick = () => {
                overlay.classList.remove('active');
                document.body.removeChild(tooltip);
            };
            
            // 自動關閉
            setTimeout(() => {
                if (document.body.contains(tooltip)) {
                    overlay.classList.remove('active');
                    document.body.removeChild(tooltip);
                }
            }, 10000);
        }
        
        // 更新導航按鈕狀態
        function updateNavButtons() {
            // 如果在首頁，隱藏返回按鈕
            if (gameState.currentPage === 'homePage') {
                backBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'flex';
            }
        }
        
        // 返回上一頁
        function goBack() {
            if (gameState.pageHistory.length > 1) {
                // 移除當前頁面
                gameState.pageHistory.pop();
                // 獲取上一頁
                const prevPage = gameState.pageHistory[gameState.pageHistory.length - 1];
                showPage(prevPage);
            } else {
                showPage('homePage');
            }
        }
        
        // 初始化教學模式頁面
        function initTutorialPage() {
            updateTutorialStats();
            generateTutorialStepsList();
            setupTutorialStep1();
            setupTutorialStep2();
            setupTutorialStep3();
            setupTutorialStep4();
            setupTutorialControls();
            updateTutorialHint();
            
            // 激活當前階段的第一步
            const currentStageScreen = document.getElementById(`tutorialStep${gameState.tutorial.currentStage}Screen`);
            if (currentStageScreen) {
                const firstStep = currentStageScreen.querySelector('.tutorial-step');
                if (firstStep) {
                    activateTutorialStep(firstStep);
                }
            }
        }
        
        // 更新教學統計數據顯示
        function updateTutorialStats() {
            document.getElementById('tutorialKnowledgeScore').textContent = gameState.tutorial.knowledgeScore;
            document.getElementById('tutorialPracticeScore').textContent = gameState.tutorial.practiceScore;
            document.getElementById('tutorialTestScore').textContent = gameState.tutorial.testScore;
            document.getElementById('tutorialProgressText').textContent = `${gameState.tutorial.progress}%`;
            document.getElementById('tutorialProgressBar').style.width = `${gameState.tutorial.progress}%`;
            document.getElementById('footerTutorialStage').textContent = getTutorialStageName(gameState.tutorial.currentStage);
            document.getElementById('footerKnowledgeScore').textContent = gameState.tutorial.knowledgeScore;
            
            // 更新成就顯示
            updateTutorialAchievements();
        }
        
        // 獲取教學階段名稱
        function getTutorialStageName(stage) {
            const stages = {
                1: '加密基礎',
                2: '隧道建立',
                3: '認證系統',
                4: '安全測試'
            };
            return stages[stage] || '未知階段';
        }
        
        // 更新教學成就
        function updateTutorialAchievements() {
            const achievements = document.querySelectorAll('#tutorialHint + .panel .stat-item div:last-child');
            if (achievements.length >= 4) {
                achievements[0].textContent = `${Math.min(100, gameState.tutorial.knowledgeScore)}%`;
                achievements[1].textContent = `${Math.min(100, gameState.tutorial.practiceScore)}%`;
                achievements[2].textContent = `${Math.min(100, gameState.tutorial.testScore)}%`;
                achievements[3].textContent = `${Math.min(100, gameState.tutorial.progress)}%`;
            }
        }
        
        // 生成教學階段列表
        function generateTutorialStepsList() {
            const stepsList = document.getElementById('tutorialStepsList');
            stepsList.innerHTML = '';
            
            const stepTitles = [
                '', // 索引0不使用
                '加密基礎',
                '隧道建立',
                '認證系統',
                '安全測試'
            ];
            
            for (let i = 1; i <= 4; i++) {
                const stepItem = document.createElement('div');
                stepItem.className = 'compact-level-item';
                if (i === gameState.tutorial.currentStage) {
                    stepItem.classList.add('active');
                }
                if (gameState.tutorial.completedSteps.includes(i)) {
                    stepItem.classList.add('completed');
                }
                stepItem.setAttribute('data-stage', i);
                
                stepItem.innerHTML = `
                    <div class="compact-level-number">${i}</div>
                    <div class="compact-level-title">${stepTitles[i]}</div>
                    ${gameState.tutorial.completedSteps.includes(i) ? '<i class="fas fa-check" style="color: var(--success); margin-left: auto;"></i>' : ''}
                `;
                
                stepItem.addEventListener('click', function() {
                    const stage = parseInt(this.getAttribute('data-stage'));
                    
                    // 更新活動階段標記
                    document.querySelectorAll('#tutorialStepsList .compact-level-item').forEach(li => {
                        li.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 切換教學階段
                    switchTutorialStage(stage);
                });
                
                stepsList.appendChild(stepItem);
            }
        }
        
        // 切換教學階段
        function switchTutorialStage(stage) {
            // 隱藏所有教學階段屏幕
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // 顯示選中的教學階段屏幕
            const stageScreen = document.getElementById(`tutorialStep${stage}Screen`);
            if (stageScreen) {
                stageScreen.classList.add('active');
                gameState.tutorial.currentStage = stage;
                updateTutorialStats();
                updateTutorialHint();
                addTutorialLogMessage(`切換到教學階段${stage}: ${getTutorialStageName(stage)}`, "info");
                
                // 激活當前階段的第一步
                const firstStep = stageScreen.querySelector('.tutorial-step');
                if (firstStep) {
                    activateTutorialStep(firstStep);
                }
                
                // 保存狀態
                saveGameState();
            }
        }
        
        // 激活教學步驟
        function activateTutorialStep(stepElement) {
            // 移除所有步驟的active類
            document.querySelectorAll('.tutorial-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // 添加active類到當前步驟
            stepElement.classList.add('active');
            
            // 更新當前步驟編號
            const stepNumber = stepElement.getAttribute('data-step');
            if (stepNumber) {
                const parts = stepNumber.split('.');
                if (parts.length === 2) {
                    gameState.tutorial.currentStep = parseInt(parts[1]);
                }
            }
        }
        
        // 更新教學提示
        function updateTutorialHint() {
            const hintElement = document.getElementById('tutorialHint');
            const hints = [
                '', // 索引0不使用
                '在加密基礎階段，你需要理解對稱加密與非對稱加密的區別，以及不同加密算法的適用場景。',
                '在隧道建立階段，你需要學習VPN隧道的工作原理，掌握不同隧道協議的特點和應用場景。',
                '在認證系統階段，你需要了解各種身份驗證方式，掌握雙因素認證和證書管理的原理。',
                '在安全測試階段，你需要學習如何檢測VPN安全漏洞，掌握完整的安全測試流程。'
            ];
            
            if (hints[gameState.tutorial.currentStage]) {
                hintElement.textContent = hints[gameState.tutorial.currentStage];
            }
        }
        
        // 設置教學階段1功能
        function setupTutorialStep1() {
            // 命令計時器和最後命令
            let lastCommandTime = 0;
            let lastCommand = '';
            
            // 教學步驟點擊事件
            const tutorialSteps = document.querySelectorAll('#tutorialStep1Screen .tutorial-step');
            tutorialSteps.forEach(step => {
                step.addEventListener('click', function() {
                    activateTutorialStep(this);
                });
            });
            
            // 測試按鈕事件
            document.getElementById('tutorial1TestAESBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial1TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> test-aes`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '測試AES-256加密... 加密強度: 95%, 性能影響: 15%, 測試通過!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("AES-256加密測試完成，加密強度95%。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.practiceScore += 5;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial1TestRSABtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial1TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> test-rsa`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '測試RSA-2048加密... 公鑰/私鑰交換成功, 測試通過!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("RSA-2048加密測試完成，密鑰交換成功。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.practiceScore += 5;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial1CompareBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial1TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> compare`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '加密算法比較結果:\nAES-256: 安全性95%, 性能85%\nRSA-2048: 安全性90%, 性能70%\nChaCha20: 安全性92%, 性能95%';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("加密算法比較完成。", "info");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 15;
                updateTutorialStats();
                saveGameState();
            });
            
            // 命令輸入事件
            const commandInput = document.getElementById('tutorial1CommandInput');
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const command = this.value.trim().toLowerCase();
                    if (!command) return;
                    
                    // 檢查重複命令
                    const now = Date.now();
                    if (now - lastCommandTime < 3000 && command === lastCommand) {
                        addTutorialLogMessage(`命令 "${command}" 已在3秒內執行過，請稍後再試。`, "warning");
                        return;
                    }
                    
                    lastCommandTime = now;
                    lastCommand = command;
                    
                    const output = document.getElementById('tutorial1TestOutput');
                    
                    // 移除舊的輸入框
                    const oldInputs = output.querySelectorAll('.command-input');
                    if (oldInputs.length > 1) {
                        const oldInput = oldInputs[oldInputs.length - 2];
                        if (oldInput && oldInput.parentNode) {
                            oldInput.parentNode.remove();
                        }
                    }
                    
                    const newLine = document.createElement('div');
                    newLine.className = 'command-line';
                    newLine.innerHTML = `<span class="command-prompt">$</span> ${command}`;
                    output.appendChild(newLine);
                    
                    let result = '';
                    let logType = "info";
                    let score = 0;
                    
                    if (command === 'test-aes') {
                        result = '測試AES-256加密... 加密強度: 95%, 性能影響: 15%, 測試通過!';
                        logType = "success";
                        score = 10;
                    } else if (command === 'test-rsa') {
                        result = '測試RSA-2048加密... 公鑰/私鑰交換成功, 測試通過!';
                        logType = "success";
                        score = 10;
                    } else if (command === 'compare') {
                        result = '加密算法比較結果:\nAES-256: 安全性95%, 性能85%\nRSA-2048: 安全性90%, 性能70%\nChaCha20: 安全性92%, 性能95%';
                        logType = "info";
                        score = 15;
                    } else {
                        result = `未知命令: ${command}`;
                        logType = "warning";
                    }
                    
                    const resultLine = document.createElement('div');
                    resultLine.className = 'command-line';
                    resultLine.style.color = '#cbd5e1';
                    resultLine.textContent = result;
                    output.appendChild(resultLine);
                    
                    // 添加新的命令提示
                    const prompt = document.createElement('div');
                    prompt.className = 'command-line';
                    prompt.innerHTML = `<span class="command-prompt">$</span> <input type="text" class="command-input" placeholder="輸入測試命令..." style="background: transparent; border: none; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 1rem; width: calc(100% - 20px); outline: none;">`;
                    output.appendChild(prompt);
                    
                    // 移除舊的輸入框
                    this.parentNode.removeChild(this);
                    
                    // 聚焦到新的輸入框
                    const newInput = prompt.querySelector('.command-input');
                    newInput.focus();
                    
                    // 為新輸入框添加事件監聽
                    newInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            const event = new KeyboardEvent('keypress', {key: 'Enter'});
                            this.dispatchEvent(event);
                        }
                    });
                    
                    output.scrollTop = output.scrollHeight;
                    
                    if (score > 0) {
                        gameState.tutorial.knowledgeScore += score;
                        updateTutorialStats();
                        saveGameState();
                    }
                    
                    addTutorialLogMessage(`執行命令: ${command}`, logType);
                }
            });
        }
        
        // 設置教學階段2功能
        function setupTutorialStep2() {
            // 教學步驟點擊事件
            const tutorialSteps = document.querySelectorAll('#tutorialStep2Screen .tutorial-step');
            tutorialSteps.forEach(step => {
                step.addEventListener('click', function() {
                    activateTutorialStep(this);
                });
            });
            
            // 測試按鈕事件
            document.getElementById('tutorial2CreateTunnelBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial2TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> create-tunnel`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '建立VPN隧道... 握手協議完成, 加密參數協商成功, 隧道建立完成!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("VPN隧道建立測試完成。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.practiceScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial2TestSpeedBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial2TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> test-speed`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '隧道速度測試... PPTP: 95Mbps, L2TP/IPsec: 70Mbps, OpenVPN: 50Mbps';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("隧道速度測試完成。", "info");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial2SimulateAttackBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial2TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> simulate-attack`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '模擬中間人攻擊... PPTP隧道被攻破! L2TP/IPsec隧道防禦成功! OpenVPN隧道防禦成功!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("中間人攻擊模擬完成，PPTP協議存在安全漏洞。", "warning");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 15;
                gameState.tutorial.testScore += 10;
                updateTutorialStats();
                saveGameState();
            });
        }
        
        // 設置教學階段3功能
        function setupTutorialStep3() {
            // 教學步驟點擊事件
            const tutorialSteps = document.querySelectorAll('#tutorialStep3Screen .tutorial-step');
            tutorialSteps.forEach(step => {
                step.addEventListener('click', function() {
                    activateTutorialStep(this);
                });
            });
            
            // 測試按鈕事件
            document.getElementById('tutorial3TestPasswordBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial3TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> test-password`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '測試密碼認證... 安全性: 60%, 易用性: 90%, 存在暴力破解風險!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("密碼認證測試完成，存在安全風險。", "warning");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial3Test2FABtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial3TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> test-2fa`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '測試雙因素認證... 安全性: 95%, 易用性: 70%, 防禦暴力破解成功!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("雙因素認證測試完成，安全性高。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.practiceScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial3BruteForceBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial3TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> brute-force`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '模擬暴力破解攻擊... 簡單密碼: 5秒破解! 強密碼: 預計30天破解! 2FA: 無法破解!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("暴力破解模擬完成，2FA提供最佳保護。", "info");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 15;
                gameState.tutorial.testScore += 10;
                updateTutorialStats();
                saveGameState();
            });
        }
        
        // 設置教學階段4功能
        function setupTutorialStep4() {
            // 教學步驟點擊事件
            const tutorialSteps = document.querySelectorAll('#tutorialStep4Screen .tutorial-step');
            tutorialSteps.forEach(step => {
                step.addEventListener('click', function() {
                    activateTutorialStep(this);
                });
            });
            
            // 測試按鈕事件
            document.getElementById('tutorial4DNSLeakBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial4TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> dns-leak`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = 'DNS洩漏測試... 無DNS保護: 洩漏檢測! 啟用DNS保護: 無洩漏!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("DNS洩漏測試完成，DNS保護功能有效。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.testScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial4WebRTCTestBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial4TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> webrtc-test`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = 'WebRTC洩漏測試... 無保護: IP地址洩漏! 啟用保護: 無洩漏!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("WebRTC洩漏測試完成，保護功能有效。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.testScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial4KillSwitchBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial4TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> kill-switch`;
                output.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '終止開關測試... VPN斷開連接, 終止開關激活, 所有網絡流量已阻止!';
                output.appendChild(result);
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("終止開關測試完成，功能正常。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 10;
                gameState.tutorial.practiceScore += 10;
                updateTutorialStats();
                saveGameState();
            });
            
            document.getElementById('tutorial4FullTestBtn').addEventListener('click', function() {
                const output = document.getElementById('tutorial4TestOutput');
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">$</span> full-test`;
                output.appendChild(newLine);
                
                const results = [
                    '完整安全測試開始...',
                    '1. DNS洩漏測試: 通過 ✓',
                    '2. WebRTC測試: 通過 ✓',
                    '3. 終止開關測試: 通過 ✓',
                    '4. 加密完整性測試: 通過 ✓',
                    '5. 協議安全性測試: 通過 ✓',
                    '所有安全測試通過! VPN配置安全。'
                ];
                
                results.forEach(text => {
                    const result = document.createElement('div');
                    result.className = 'command-line';
                    result.style.color = text.includes('✓') ? 'var(--success)' : '#cbd5e1';
                    result.textContent = text;
                    output.appendChild(result);
                });
                
                output.scrollTop = output.scrollHeight;
                addTutorialLogMessage("完整安全測試完成，所有項目通過。", "success");
                
                // 更新分數
                gameState.tutorial.knowledgeScore += 20;
                gameState.tutorial.practiceScore += 20;
                gameState.tutorial.testScore += 20;
                updateTutorialStats();
                saveGameState();
            });
        }
        
        // 設置教學控制
        function setupTutorialControls() {
            const prevBtn = document.getElementById('prevTutorialStepBtn');
            const nextBtn = document.getElementById('nextTutorialStepBtn');
            const testBtn = document.getElementById('tutorialTestBtn');
            const quizBtn = document.getElementById('tutorialQuizBtn');
            
            // 上一步
            prevBtn.addEventListener('click', function() {
                if (gameState.tutorial.currentStage > 1) {
                    switchTutorialStage(gameState.tutorial.currentStage - 1);
                }
            });
            
            // 下一步
            nextBtn.addEventListener('click', function() {
                if (gameState.tutorial.currentStage < 4) {
                    // 標記當前階段為完成
                    if (!gameState.tutorial.completedSteps.includes(gameState.tutorial.currentStage)) {
                        gameState.tutorial.completedSteps.push(gameState.tutorial.currentStage);
                        gameState.tutorial.progress += 25;
                        updateTutorialStats();
                        generateTutorialStepsList();
                        saveGameState();
                    }
                    
                    switchTutorialStage(gameState.tutorial.currentStage + 1);
                } else {
                    // 完成所有教學階段
                    if (!gameState.tutorial.completedSteps.includes(4)) {
                        gameState.tutorial.completedSteps.push(4);
                        gameState.tutorial.progress = 100;
                        updateTutorialStats();
                        generateTutorialStepsList();
                        addTutorialLogMessage("恭喜！你已完成所有教學階段！", "success");
                        saveGameState();
                    }
                }
            });
            
            // 階段測試
            testBtn.addEventListener('click', function() {
                const testQuestions = {
                    1: [
                        {q: "對稱加密使用相同的密鑰進行加密和解密？", a: true},
                        {q: "AES-256的安全性比RSA-2048低？", a: false},
                        {q: "ChaCha20專為移動設備優化？", a: true}
                    ],
                    2: [
                        {q: "PPTP協議安全性最高？", a: false},
                        {q: "OpenVPN是開源協議？", a: true},
                        {q: "L2TP/IPsec提供速度與安全性的平衡？", a: true}
                    ],
                    3: [
                        {q: "雙因素認證結合兩種不同類型的認證？", a: true},
                        {q: "證書認證易用性最高？", a: false},
                        {q: "生物認證可能存在隱私問題？", a: true}
                    ],
                    4: [
                        {q: "終止開關在VPN斷開時阻止流量？", a: true},
                        {q: "WebRTC可能洩露真實IP？", a: true},
                        {q: "DNS洩漏測試不必要？", a: false}
                    ]
                };
                
                const questions = testQuestions[gameState.tutorial.currentStage];
                if (!questions) return;
                
                let score = 0;
                questions.forEach((question, index) => {
                    const answer = confirm(`測試問題 ${index + 1}: ${question.q}\n\n請選擇:\n確定 = 正確\n取消 = 錯誤`);
                    if (answer === question.a) {
                        score++;
                    }
                });
                
                const percentage = Math.round((score / questions.length) * 100);
                alert(`階段測試完成!\n正確: ${score}/${questions.length}\n得分: ${percentage}%`);
                
                // 更新分數
                gameState.tutorial.testScore += percentage;
                updateTutorialStats();
                saveGameState();
                
                addTutorialLogMessage(`階段測試完成，得分: ${percentage}%`, percentage >= 70 ? "success" : "warning");
            });
            
            // 知識問答
            quizBtn.addEventListener('click', function() {
                startQuiz(gameState.tutorial.currentStage);
            });
        }
        
        // 開始問答
        let currentQuiz = {
            stage: 1,
            questions: [],
            currentQuestion: 0,
            score: 0
        };
        
        function startQuiz(stage) {
            const questions = questionBank[stage];
            if (!questions || questions.length === 0) {
                alert('此階段暫無問答題目');
                return;
            }
            
            currentQuiz = {
                stage: stage,
                questions: [...questions],
                currentQuestion: 0,
                score: 0
            };
            
            showQuestion();
        }
        
        function showQuestion() {
            const modal = document.getElementById('qaModal');
            const questionText = document.getElementById('qaQuestionText');
            const optionsContainer = document.getElementById('qaOptions');
            const explanation = document.getElementById('qaExplanation');
            const nextBtn = document.getElementById('qaNextBtn');
            const closeBtn = document.getElementById('qaCloseBtn');
            
            if (currentQuiz.currentQuestion >= currentQuiz.questions.length) {
                // 顯示結果
                questionText.textContent = `問答完成！得分: ${currentQuiz.score}/${currentQuiz.questions.length}`;
                optionsContainer.innerHTML = '';
                explanation.innerHTML = `你答對了 ${currentQuiz.score} 題，共 ${currentQuiz.questions.length} 題`;
                explanation.classList.add('active');
                nextBtn.style.display = 'none';
                closeBtn.textContent = '關閉';
                
                // 更新分數
                const percentage = Math.round((currentQuiz.score / currentQuiz.questions.length) * 100);
                gameState.tutorial.knowledgeScore += percentage;
                updateTutorialStats();
                saveGameState();
                
                modal.classList.add('active');
                return;
            }
            
            const question = currentQuiz.questions[currentQuiz.currentQuestion];
            questionText.textContent = `問題 ${currentQuiz.currentQuestion + 1}: ${question.question}`;
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'qa-option';
                optionElement.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionElement.dataset.index = index;
                
                optionElement.addEventListener('click', function() {
                    if (this.classList.contains('selected')) return;
                    
                    const selectedIndex = parseInt(this.dataset.index);
                    const isCorrect = selectedIndex === question.answer;
                    
                    // 顯示正確/錯誤
                    this.classList.add('selected');
                    if (isCorrect) {
                        this.classList.add('correct');
                        currentQuiz.score++;
                    } else {
                        this.classList.add('wrong');
                        // 顯示正確答案
                        const correctOption = optionsContainer.querySelector(`.qa-option[data-index="${question.answer}"]`);
                        if (correctOption) {
                            correctOption.classList.add('correct');
                        }
                    }
                    
                    // 顯示解析
                    explanation.innerHTML = `<strong>${isCorrect ? '正確！' : '錯誤！'}</strong> ${question.explanation}`;
                    explanation.classList.add('active');
                    
                    // 禁用所有選項
                    optionsContainer.querySelectorAll('.qa-option').forEach(opt => {
                        opt.style.pointerEvents = 'none';
                    });
                    
                    nextBtn.style.display = 'inline-block';
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            explanation.classList.remove('active');
            explanation.innerHTML = '';
            nextBtn.style.display = 'none';
            closeBtn.textContent = '跳過';
            
            modal.classList.add('active');
            
            // 下一題按鈕
            nextBtn.onclick = function() {
                currentQuiz.currentQuestion++;
                showQuestion();
            };
            
            // 關閉按鈕
            closeBtn.onclick = function() {
                modal.classList.remove('active');
            };
        }
        
        // 初始化挑戰模式頁面
        function initChallengePage() {
            updateChallengeStats();
            generateChallengeLevelList();
            setupChallengeLevel1();
            setupChallengeLevel2();
            setupChallengeControls();
            updateChallengeHint();
            setupChallengeSimulationTest();
            
            // 切換到當前關卡
            switchChallengeLevel(gameState.challenge.currentLevel);
        }
        
        // 更新挑戰統計數據顯示
        function updateChallengeStats() {
            document.getElementById('challengeSecurityScore').textContent = gameState.challenge.securityScore;
            document.getElementById('challengeSpeedScore').textContent = gameState.challenge.speedScore;
            document.getElementById('challengeStabilityScore').textContent = gameState.challenge.stabilityScore;
            document.getElementById('challengeProgressText').textContent = `${gameState.challenge.progress}%`;
            document.getElementById('challengeProgressBar').style.width = `${gameState.challenge.progress}%`;
            document.getElementById('currentLevelDisplay').textContent = gameState.challenge.currentLevel;
            document.getElementById('currentLevelTitle').textContent = getChallengeLevelTitle(gameState.challenge.currentLevel);
            document.getElementById('footerChallengeLevel').textContent = gameState.challenge.currentLevel;
            document.getElementById('footerChallengeSecurity').textContent = gameState.challenge.securityScore;
            
            // 更新成就顯示
            updateChallengeAchievements();
        }
        
        // 獲取挑戰關卡標題
        function getChallengeLevelTitle(level) {
            const titles = {
                1: '數據加密基礎',
                2: '建立VPN隧道',
                3: '用戶認證系統',
                4: 'VPN協議進階選擇',
                5: '伺服器配置',
                6: '客戶端設置',
                7: '防火牆配置',
                8: '防禦攻擊測試',
                9: '隱私保護設置',
                10: '完整VPN部署'
            };
            return titles[level] || '未知關卡';
        }
        
        // 更新挑戰成就
        function updateChallengeAchievements() {
            const achievements = document.querySelectorAll('#challengeCurrentHint + .panel .stat-item div:last-child');
            if (achievements.length >= 4) {
                achievements[0].textContent = `${gameState.challenge.progress}%`;
                achievements[1].textContent = gameState.challenge.securityScore;
                achievements[2].textContent = gameState.challenge.speedScore;
                
                let rating = '新手';
                if (gameState.challenge.securityScore >= 80) rating = '專家';
                else if (gameState.challenge.securityScore >= 60) rating = '熟練';
                else if (gameState.challenge.securityScore >= 40) rating = '初級';
                achievements[3].textContent = rating;
            }
        }
        
        // 生成挑戰關卡列表
        function generateChallengeLevelList() {
            const levelList = document.getElementById('challengeLevelList');
            levelList.innerHTML = '';
            
            const levelTitles = {
                1: '加密基礎',
                2: '建立隧道',
                3: '用戶認證',
                4: '協議選擇',
                5: '伺服器配置',
                6: '客戶端設置',
                7: '防火牆',
                8: '防禦攻擊',
                9: '隱私保護',
                10: '完整部署'
            };
            
            for (let i = 1; i <= 10; i++) {
                const levelItem = document.createElement('div');
                levelItem.className = 'compact-level-item';
                if (i === gameState.challenge.currentLevel) {
                    levelItem.classList.add('active');
                }
                if (gameState.challenge.completedLevels.includes(i)) {
                    levelItem.classList.add('completed');
                }
                levelItem.setAttribute('data-level', i);
                
                levelItem.innerHTML = `
                    <div class="compact-level-number">${i}</div>
                    <div class="compact-level-title">${levelTitles[i]}</div>
                    ${gameState.challenge.completedLevels.includes(i) ? '<i class="fas fa-check" style="color: var(--success); margin-left: auto;"></i>' : ''}
                `;
                
                levelItem.addEventListener('click', function() {
                    const level = parseInt(this.getAttribute('data-level'));
                    
                    // 只能選擇已解鎖的關卡（當前關卡或已完成的關卡）
                    if (level <= gameState.challenge.currentLevel || gameState.challenge.completedLevels.includes(level)) {
                        // 更新活動關卡標記
                        document.querySelectorAll('#challengeLevelList .compact-level-item').forEach(li => {
                            li.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // 切換關卡
                        switchChallengeLevel(level);
                    } else {
                        addChallengeLogMessage(`關卡${level}尚未解鎖，請先完成當前關卡。`, "warning");
                    }
                });
                
                levelList.appendChild(levelItem);
            }
        }
        
        // 切換挑戰關卡
        function switchChallengeLevel(level) {
            // 重置當前關卡狀態
            resetChallengeLevelState(gameState.challenge.currentLevel);
            
            // 隱藏所有關卡屏幕
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // 顯示選中的關卡屏幕
            const levelScreen = document.getElementById(`challengeLevel${level}Screen`);
            if (levelScreen) {
                levelScreen.classList.add('active');
                gameState.challenge.currentLevel = level;
                updateChallengeStats();
                updateChallengeHint();
                addChallengeLogMessage(`切換到關卡${level}: ${getChallengeLevelTitle(level)}`, "info");
                saveGameState();
            }
        }
        
        // 重置關卡狀態
        function resetChallengeLevelState(level) {
            switch(level) {
                case 1:
                    gameState.challenge.encryptionType = null;
                    break;
                case 2:
                    gameState.challenge.protocolType = null;
                    break;
            }
        }
        
        // 更新挑戰提示
        function updateChallengeHint() {
            const hintElement = document.getElementById('challengeCurrentHint');
            const hints = {
                1: '在關卡1中，你需要選擇合適的加密算法來保護數據。AES-256提供了最好的安全性，而ChaCha20則在移動設備上性能更好。',
                2: '在關卡2中，你需要選擇合適的VPN協議。PPTP速度最快但安全性低，OpenVPN安全性最高但速度較慢，L2TP/IPsec則提供了良好的平衡。',
                3: '在關卡3中，你需要配置用戶認證系統。雙因素認證提供了更高的安全性，但可能降低用戶體驗。根據安全需求選擇合適的認證方式。',
                4: '在關卡4中，你需要根據不同場景選擇VPN協議。考慮速度、安全性和兼容性的平衡。',
                5: '在關卡5中，你需要配置VPN伺服器參數。合理分配資源以平衡性能與成本。',
                6: '在關卡6中，你需要配置不同平台的客戶端。注意跨平台兼容性和用戶體驗。',
                7: '在關卡7中，你需要配置防火牆規則。正確的規則可以有效阻擋惡意流量而不影響正常使用。',
                8: '在關卡8中，你需要防禦模擬攻擊。根據攻擊類型調整防護策略。',
                9: '在關卡9中，你需要配置隱私保護功能。無日誌政策和DNS保護對隱私至關重要。',
                10: '在關卡10中，你需要部署完整VPN服務。綜合所有知識創建最佳配置。'
            };
            
            if (hints[gameState.challenge.currentLevel]) {
                hintElement.textContent = hints[gameState.challenge.currentLevel];
            }
        }
        
        // 設置挑戰關卡1功能
        function setupChallengeLevel1() {
            const components = document.querySelectorAll('#challengeLevel1Screen .component');
            const dropZone = document.getElementById('challengeEncryptionDropZone');
            const sendDataBtn = document.getElementById('challengeSendDataBtn');
            const nextLevelBtn = document.getElementById('challengeNextLevelBtn');
            const currentEncryptionEl = document.getElementById('challengeCurrentEncryption');
            const encryptionStrengthEl = document.getElementById('challengeEncryptionStrength');
            const performanceImpactEl = document.getElementById('challengePerformanceImpact');
            
            // 初始化拖放功能
            let draggedComponent = null;
            
            components.forEach(comp => {
                comp.setAttribute('draggable', 'true');
                
                comp.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-type'));
                    this.style.opacity = '0.5';
                    draggedComponent = this.getAttribute('data-type');
                });
                
                comp.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                    draggedComponent = null;
                });
                
                // 觸控支持
                comp.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.opacity = '0.5';
                    draggedComponent = this.getAttribute('data-type');
                });
                
                comp.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                    draggedComponent = null;
                });
            });
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('active');
                
                const encryptionType = e.dataTransfer.getData('text/plain') || draggedComponent;
                if (!encryptionType) return;
                
                handleEncryptionSelect(encryptionType);
            });
            
            // 觸控放置
            dropZone.addEventListener('touchmove', function(e) {
                e.preventDefault();
            });
            
            dropZone.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.classList.remove('active');
                
                if (draggedComponent) {
                    handleEncryptionSelect(draggedComponent);
                }
            });
            
            function handleEncryptionSelect(encryptionType) {
                gameState.challenge.encryptionType = encryptionType;
                
                let encryptionName = "";
                let strength = 0;
                let performance = 0;
                
                switch(encryptionType) {
                    case 'aes':
                        encryptionName = "AES-256";
                        strength = 95;
                        performance = 85;
                        break;
                    case 'rsa':
                        encryptionName = "RSA-2048";
                        strength = 90;
                        performance = 70;
                        break;
                    case 'chaCha':
                        encryptionName = "ChaCha20";
                        strength = 92;
                        performance = 95;
                        break;
                }
                
                currentEncryptionEl.textContent = encryptionName;
                encryptionStrengthEl.textContent = `${strength}%`;
                performanceImpactEl.textContent = `${performance}%`;
                
                dropZone.innerHTML = `
                    <i class="fas fa-shield-alt" style="font-size: 1.8rem; color: var(--success); margin-bottom: 10px;"></i>
                    <div><strong>${encryptionName}</strong></div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">加密強度: ${strength}% | 性能: ${performance}%</div>
                `;
                dropZone.style.borderStyle = "solid";
                dropZone.style.borderColor = "var(--success)";
                
                addChallengeLogMessage(`已選擇${encryptionName}加密，加密強度${strength}%。`, "success");
            }
            
            // 傳送數據功能
            sendDataBtn.addEventListener('click', function() {
                if (!gameState.challenge.encryptionType) {
                    addChallengeLogMessage("請先選擇加密算法。", "warning");
                    return;
                }
                
                // 顯示連接線
                const connectionLine = document.getElementById('challengeConnectionLine');
                const dataPacket = document.getElementById('challengeDataPacket');
                
                // 計算連接線
                const clientRect = document.querySelector('#challengeLevel1Screen .client-node').getBoundingClientRect();
                const serverRect = document.querySelector('#challengeLevel1Screen .server-node').getBoundingClientRect();
                const gameRect = document.querySelector('.main-game').getBoundingClientRect();
                
                const startX = clientRect.left + clientRect.width/2 - gameRect.left;
                const startY = clientRect.top + clientRect.height/2 - gameRect.top;
                const endX = serverRect.left + serverRect.width/2 - gameRect.left;
                const endY = serverRect.top + serverRect.height/2 - gameRect.top;
                
                // 計算距離和角度
                const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                
                // 設置連接線
                connectionLine.style.width = `${length}px`;
                connectionLine.style.left = `${startX}px`;
                connectionLine.style.top = `${startY}px`;
                connectionLine.style.transform = `rotate(${angle}deg)`;
                connectionLine.style.display = "block";
                
                // 動畫傳送數據包
                let posX = startX;
                let posY = startY;
                const endPosX = endX - 20;
                const endPosY = endY - 20;
                
                // 禁用按鈕
                sendDataBtn.disabled = true;
                sendDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 傳送中...';
                
                const animatePacket = setInterval(() => {
                    posX += (endPosX - startX) / 25;
                    posY += (endPosY - startY) / 25;
                    
                    dataPacket.style.left = `${posX}px`;
                    dataPacket.style.top = `${posY}px`;
                    
                    if (Math.abs(posX - endPosX) < 5 && Math.abs(posY - endPosY) < 5) {
                        clearInterval(animatePacket);
                        
                        // 完成動畫
                        setTimeout(() => {
                            dataPacket.style.display = "none";
                        }, 300);
                        
                        addChallengeLogMessage("數據傳輸成功！數據已安全到達伺服器。", "success");
                        addChallengeLogMessage("恭喜！你已完成關卡1挑戰。", "success");
                        
                        // 更新遊戲狀態
                        if (!gameState.challenge.completedLevels.includes(1)) {
                            gameState.challenge.completedLevels.push(1);
                            gameState.challenge.securityScore += 20;
                            gameState.challenge.progress += 10;
                            updateChallengeStats();
                            
                            // 標記關卡為完成
                            document.querySelector(`#challengeLevelList .compact-level-item[data-level="1"]`).classList.add('completed');
                            
                            // 解鎖下一關
                            if (gameState.challenge.currentLevel === 1) {
                                gameState.challenge.currentLevel = 2;
                                generateChallengeLevelList();
                            }
                        }
                        
                        // 顯示下一關按鈕
                        nextLevelBtn.style.display = "inline-block";
                        sendDataBtn.style.display = "none";
                        
                        saveGameState();
                    }
                }, 30);
            });
            
            // 下一關按鈕
            nextLevelBtn.addEventListener('click', function() {
                switchChallengeLevel(2);
                this.style.display = "none";
                sendDataBtn.style.display = "inline-block";
                sendDataBtn.disabled = false;
                sendDataBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 傳送數據';
            });
        }
        
        // 設置挑戰關卡2功能
        function setupChallengeLevel2() {
            const protocolOptions = document.querySelectorAll('#challengeLevel2Screen .protocol-option');
            const createTunnelBtn = document.getElementById('challengeCreateTunnelBtn');
            const selectedProtocolEl = document.getElementById('challengeSelectedProtocol');
            const tunnelVisual = document.getElementById('challengeTunnelVisual');
            const tunnelStatus = document.getElementById('challengeTunnelStatus');
            const nextLevelBtn2 = document.getElementById('challengeNextLevelBtn2');
            
            // 選擇協議
            protocolOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有選中狀態
                    protocolOptions.forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // 設置當前選中
                    this.classList.add('selected');
                    
                    const protocol = this.getAttribute('data-protocol');
                    gameState.challenge.protocolType = protocol;
                    
                    let protocolName = "";
                    switch(protocol) {
                        case 'pptp':
                            protocolName = "PPTP協議";
                            break;
                        case 'l2tp':
                            protocolName = "L2TP/IPsec協議";
                            break;
                        case 'openvpn':
                            protocolName = "OpenVPN協議";
                            break;
                    }
                    
                    selectedProtocolEl.textContent = protocolName;
                    tunnelStatus.innerHTML = `<span class="log-info">已選擇${protocolName}，點擊「建立隧道」按鈕開始建立VPN連接。</span>`;
                    addChallengeLogMessage(`已選擇${protocolName}。`, "info");
                });
            });
            
            // 建立隧道
            createTunnelBtn.addEventListener('click', function() {
                if (!gameState.challenge.protocolType) {
                    addChallengeLogMessage("請先選擇VPN協議。", "warning");
                    return;
                }
                
                // 禁用按鈕
                createTunnelBtn.disabled = true;
                createTunnelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 建立中...';
                
                // 顯示隧道可視化
                tunnelVisual.style.display = "block";
                tunnelVisual.style.top = "80px";
                tunnelVisual.style.left = "100px";
                tunnelVisual.style.right = "100px";
                tunnelVisual.style.height = "60px";
                
                // 動畫效果
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    tunnelVisual.style.borderColor = progress < 50 ? 'var(--warning)' : progress < 80 ? 'var(--primary)' : 'var(--success)';
                    tunnelVisual.style.borderStyle = progress < 100 ? 'dashed' : 'solid';
                    tunnelVisual.style.backgroundColor = `rgba(59, 130, 246, ${progress/200})`;
                    
                    tunnelStatus.innerHTML = `<span class="log-info">建立隧道中... ${progress}%</span>`;
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        
                        // 完成動畫
                        tunnelVisual.style.borderColor = 'var(--success)';
                        tunnelVisual.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
                        
                        // 添加成功動畫
                        tunnelVisual.animate([
                            { transform: 'scale(1)' },
                            { transform: 'scale(1.05)' },
                            { transform: 'scale(1)' }
                        ], {
                            duration: 500,
                            iterations: 2
                        });
                        
                        addChallengeLogMessage("VPN隧道建立成功！客戶端與伺服器之間的安全通道已建立。", "success");
                        addChallengeLogMessage("恭喜！你已完成關卡2挑戰。", "success");
                        
                        tunnelStatus.innerHTML = `<span class="log-success">VPN隧道建立成功！安全通道已就緒。</span>`;
                        
                        // 更新遊戲狀態
                        if (!gameState.challenge.completedLevels.includes(2)) {
                            gameState.challenge.completedLevels.push(2);
                            gameState.challenge.securityScore += 25;
                            gameState.challenge.speedScore += 15;
                            gameState.challenge.progress += 10;
                            updateChallengeStats();
                            
                            // 標記關卡為完成
                            document.querySelector(`#challengeLevelList .compact-level-item[data-level="2"]`).classList.add('completed');
                            
                            // 解鎖下一關
                            if (gameState.challenge.currentLevel === 2) {
                                gameState.challenge.currentLevel = 3;
                                generateChallengeLevelList();
                            }
                        }
                        
                        // 顯示下一關按鈕
                        nextLevelBtn2.style.display = "inline-block";
                        createTunnelBtn.style.display = "none";
                        
                        saveGameState();
                    }
                }, 200);
            });
            
            // 下一關按鈕
            nextLevelBtn2.addEventListener('click', function() {
                switchChallengeLevel(3);
                this.style.display = "none";
                createTunnelBtn.style.display = "inline-block";
                createTunnelBtn.disabled = false;
                createTunnelBtn.innerHTML = '<i class="fas fa-link"></i> 建立隧道';
            });
        }
        
        // 設置挑戰控制
        function setupChallengeControls() {
            const restartBtn = document.getElementById('challengeRestartLevelBtn');
            const hintBtn = document.getElementById('challengeHintBtn');
            const testBtn = document.getElementById('challengeTestBtn');
            const simulateBtn = document.getElementById('challengeSimulateTestBtn');
            
            // 重新開始關卡
            restartBtn.addEventListener('click', function() {
                if (confirm('確定要重新開始當前關卡嗎？當前進度將重置。')) {
                    // 根據當前關卡重置狀態
                    switch(gameState.challenge.currentLevel) {
                        case 1:
                            // 重置關卡1狀態
                            gameState.challenge.encryptionType = null;
                            const dropZone = document.getElementById('challengeEncryptionDropZone');
                            dropZone.innerHTML = `
                                <i class="fas fa-cloud-upload-alt" style="font-size: 1.8rem; color: #64748b; margin-bottom: 10px;"></i>
                                <div>拖放加密算法到此處</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">選擇合適的加密算法保護數據</div>
                            `;
                            dropZone.style.borderStyle = "dashed";
                            dropZone.style.borderColor = "#64748b";
                            
                            document.getElementById('challengeCurrentEncryption').textContent = "無";
                            document.getElementById('challengeEncryptionStrength').textContent = "0%";
                            document.getElementById('challengePerformanceImpact').textContent = "0%";
                            
                            const connectionLine = document.getElementById('challengeConnectionLine');
                            connectionLine.style.display = "none";
                            
                            const dataPacket = document.getElementById('challengeDataPacket');
                            dataPacket.style.display = "flex";
                            dataPacket.style.top = "100px";
                            dataPacket.style.left = "100px";
                            
                            const sendDataBtn = document.getElementById('challengeSendDataBtn');
                            sendDataBtn.style.display = "inline-block";
                            sendDataBtn.disabled = false;
                            sendDataBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 傳送數據';
                            
                            const nextLevelBtn = document.getElementById('challengeNextLevelBtn');
                            nextLevelBtn.style.display = "none";
                            break;
                            
                        case 2:
                            // 重置關卡2狀態
                            gameState.challenge.protocolType = null;
                            document.querySelectorAll('#challengeLevel2Screen .protocol-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            
                            document.getElementById('challengeSelectedProtocol').textContent = "無";
                            document.getElementById('challengeTunnelStatus').innerHTML = "請選擇一個VPN協議開始建立隧道";
                            
                            const tunnelVisual = document.getElementById('challengeTunnelVisual');
                            tunnelVisual.style.display = "none";
                            
                            const createTunnelBtn = document.getElementById('challengeCreateTunnelBtn');
                            createTunnelBtn.style.display = "inline-block";
                            createTunnelBtn.disabled = false;
                            createTunnelBtn.innerHTML = '<i class="fas fa-link"></i> 建立隧道';
                            
                            const nextLevelBtn2 = document.getElementById('challengeNextLevelBtn2');
                            nextLevelBtn2.style.display = "none";
                            break;
                    }
                    
                    addChallengeLogMessage(`關卡${gameState.challenge.currentLevel}已重置。`, "info");
                }
            });
            
            // 提示
            hintBtn.addEventListener('click', function() {
                const hints = {
                    1: '提示：AES-256加密提供了最好的安全性，適合處理敏感數據。ChaCha20在移動設備上性能更好。',
                    2: '提示：根據安全需求選擇協議。PPTP適合臨時使用，L2TP/IPsec適合日常使用，OpenVPN適合高安全需求。',
                    3: '提示：雙因素認證提供更高安全性但可能降低用戶體驗。根據安全級別要求選擇合適的認證方式。',
                    4: '提示：根據使用場景選擇協議。流媒體需要速度，銀行交易需要安全性。',
                    5: '提示：合理分配伺服器資源。過多用戶會影響速度，過少則浪費資源。',
                    6: '提示：考慮跨平台兼容性。不同操作系統可能需要不同配置。',
                    7: '提示：防火牆規則應該最小化開放端口，僅允許必要流量。',
                    8: '提示：根據攻擊類型調整策略。DDoS攻擊需要流量清洗，中間人攻擊需要強化加密。',
                    9: '提示：無日誌政策對隱私至關重要。DNS保護防止DNS洩漏。',
                    10: '提示：綜合考慮速度、安全性和穩定性。測試不同配置找到最佳平衡。'
                };
                
                if (hints[gameState.challenge.currentLevel]) {
                    alert(hints[gameState.challenge.currentLevel]);
                    addChallengeLogMessage("已顯示關卡提示。", "info");
                }
            });
            
            // 測試連接
            testBtn.addEventListener('click', function() {
                addChallengeLogMessage("開始測試VPN連接...", "info");
                
                // 模擬測試過程
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 測試中...';
                
                setTimeout(() => {
                    // 根據當前關卡生成測試結果
                    let result = "";
                    let logType = "info";
                    
                    switch(gameState.challenge.currentLevel) {
                        case 1:
                            if (gameState.challenge.encryptionType) {
                                result = "加密連接測試成功！數據傳輸安全。";
                                logType = "success";
                            } else {
                                result = "加密連接測試失敗：未配置加密算法。";
                                logType = "error";
                            }
                            break;
                        case 2:
                            if (gameState.challenge.protocolType) {
                                result = "VPN隧道測試成功！連接穩定。";
                                logType = "success";
                            } else {
                                result = "VPN隧道測試失敗：未建立隧道。";
                                logType = "error";
                            }
                            break;
                        default:
                            result = "連接測試完成，基本功能正常。";
                            logType = "info";
                    }
                    
                    addChallengeLogMessage(result, logType);
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fas fa-vial"></i> 測試連接';
                }, 1500);
            });
            
            // 模擬測試
            simulateBtn.addEventListener('click', function() {
                const simulationTest = document.getElementById('challengeSimulationTest');
                simulationTest.style.display = 'block';
                simulationTest.scrollIntoView({ behavior: 'smooth' });
                addChallengeLogMessage("開啟模擬測試環境。", "info");
            });
        }
        
        // 設置挑戰模擬測試
        function setupChallengeSimulationTest() {
            const closeBtn = document.getElementById('challengeCloseSimulation');
            const pingBtn = document.getElementById('challengeRunPingTest');
            const speedBtn = document.getElementById('challengeRunSpeedTest');
            const ipBtn = document.getElementById('challengeCheckIP');
            const attackBtn = document.getElementById('challengeSimulateAttack');
            const terminal = document.getElementById('challengeTestTerminal');
            
            // 關閉測試
            closeBtn.addEventListener('click', function() {
                document.getElementById('challengeSimulationTest').style.display = 'none';
                addChallengeLogMessage("關閉模擬測試環境。", "info");
            });
            
            // 清空終端
            function clearTerminal() {
                terminal.innerHTML = `
                    <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> 歡迎來到關卡測試環境</div>
                    <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> 在這裡測試你的VPN配置效果</div>
                    <br>
                    <div class="command-line"><span class="command-prompt">user@vpn-test:~$</span> <input type="text" class="command-input" id="challengeTestCommandInput" placeholder="輸入測試命令..."></div>
                `;
            }
            
            // 每次打開時清空終端
            document.getElementById('challengeSimulateTestBtn').addEventListener('click', clearTerminal);
            
            // 測試連線
            pingBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-test:~$</span> ping -c 4 8.8.8.8`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = 'PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=25.3 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=117 time=26.1 ms\n64 bytes from 8.8.8.8: icmp_seq=3 ttl=117 time=24.9 ms\n64 bytes from 8.8.8.8: icmp_seq=4 ttl=117 time=25.7 ms';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addChallengeLogMessage("Ping測試完成，連接正常。", "info");
            });
            
            // 速度測試
            speedBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-test:~$</span> speedtest`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '下載速度: 85.2 Mbps\n上傳速度: 42.7 Mbps\n延遲: 25 ms\n抖動: 3 ms';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addChallengeLogMessage("速度測試完成，性能良好。", "info");
            });
            
            // 檢查IP
            ipBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-test:~$</span> curl ifconfig.me`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '203.0.113.45';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addChallengeLogMessage("IP地址檢查完成，VPN連接正常。", "info");
            });
            
            // 模擬攻擊
            attackBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-test:~$</span> simulate-attack`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '模擬中間人攻擊... VPN隧道防禦成功!\n模擬DDoS攻擊... 流量清洗成功!\n模擬端口掃描... 防火牆阻擋成功!';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addChallengeLogMessage("攻擊模擬完成，VPN防禦成功。", "success");
                
                // 更新分數
                gameState.challenge.securityScore += 5;
                updateChallengeStats();
                saveGameState();
            });
        }
        
        // 初始化自由模式頁面
        function initFreeModePage() {
            const applyFreeConfigBtn = document.getElementById('applyFreeConfig');
            const simulateBtn = document.getElementById('freeSimulateTestBtn');
            const generateBtn = document.getElementById('generateConfigCode');
            const resetBtn = document.getElementById('resetFreeConfig');
            const copyBtn = document.getElementById('copyConfigCode');
            const shareBtn = document.getElementById('shareConfigBtn');
            const presetBtns = document.querySelectorAll('.preset-btn');
            const configOutput = document.getElementById('freeConfigOutput');
            const codeContainer = document.getElementById('freeConfigCodeContainer');
            const configCode = document.getElementById('freeConfigCode');
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            
            // 預設配置按鈕
            presetBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除所有active類
                    presetBtns.forEach(b => b.classList.remove('active'));
                    // 添加active類到當前按鈕
                    this.classList.add('active');
                    
                    const preset = this.getAttribute('data-preset');
                    applyPresetConfig(preset);
                });
            });
            
            function applyPresetConfig(preset) {
                const config = presetConfigs[preset];
                if (!config) return;
                
                // 更新表單
                document.getElementById('freeEncryptionSelect').value = config.encryption;
                document.getElementById('freeEncryptionMode').value = config.encryptionMode;
                document.getElementById('freeProtocolSelect').value = config.protocol;
                document.getElementById('freePortInput').value = config.port;
                
                document.getElementById('freeAuthPassword').checked = config.authMethods.includes('password');
                document.getElementById('freeAuthCertificate').checked = config.authMethods.includes('certificate');
                document.getElementById('freeAuth2FA').checked = config.authMethods.includes('2fa');
                document.getElementById('freeAuthOTP').checked = config.authMethods.includes('otp');
                
                document.getElementById('freeKillSwitch').checked = config.features.includes('killSwitch');
                document.getElementById('freeDNSProtection').checked = config.features.includes('dnsProtection');
                document.getElementById('freeNoLogs').checked = config.features.includes('noLogs');
                document.getElementById('freeIPv6Protection').checked = config.features.includes('ipv6Protection');
                
                // 更新遊戲狀態
                gameState.freeConfig = {
                    encryption: config.encryption,
                    encryptionMode: config.encryptionMode,
                    protocol: config.protocol,
                    port: config.port,
                    authMethods: config.authMethods,
                    features: config.features
                };
                
                addFreeModeLog(`已應用「${preset}」預設配置。`, "success");
            }
            
            // 應用配置
            applyFreeConfigBtn.addEventListener('click', function() {
                // 收集配置
                const encryption = document.getElementById('freeEncryptionSelect').value;
                const encryptionMode = document.getElementById('freeEncryptionMode').value;
                const protocol = document.getElementById('freeProtocolSelect').value;
                const port = document.getElementById('freePortInput').value;
                
                const authMethods = [];
                if (document.getElementById('freeAuthPassword').checked) authMethods.push('password');
                if (document.getElementById('freeAuthCertificate').checked) authMethods.push('certificate');
                if (document.getElementById('freeAuth2FA').checked) authMethods.push('2fa');
                if (document.getElementById('freeAuthOTP').checked) authMethods.push('otp');
                
                const features = [];
                if (document.getElementById('freeKillSwitch').checked) features.push('killSwitch');
                if (document.getElementById('freeDNSProtection').checked) features.push('dnsProtection');
                if (document.getElementById('freeNoLogs').checked) features.push('noLogs');
                if (document.getElementById('freeIPv6Protection').checked) features.push('ipv6Protection');
                
                // 更新遊戲狀態
                gameState.freeConfig = {
                    encryption,
                    encryptionMode,
                    protocol,
                    port,
                    authMethods,
                    features
                };
                
                // 顯示配置輸出
                configOutput.innerHTML = `
                    <div class="command-line"><span class="command-prompt">$</span> vpn-config --apply</div>
                    <div class="command-line" style="color: var(--success);">正在應用VPN配置...</div>
                    <div class="command-line" style="color: var(--success);">加密算法: ${encryption.toUpperCase()}</div>
                    <div class="command-line" style="color: var(--success);">加密模式: ${encryptionMode.toUpperCase()}</div>
                    <div class="command-line" style="color: var(--success);">VPN協議: ${protocol}</div>
                    <div class="command-line" style="color: var(--success);">端口: ${port}</div>
                    <div class="command-line" style="color: var(--success);">認證方式: ${authMethods.join(', ')}</div>
                    <div class="command-line" style="color: var(--success);">安全功能: ${features.length} 個</div>
                    <div class="command-line" style="color: var(--success); font-weight: bold;">VPN配置已成功應用！</div>
                    <br>
                    <div class="command-line"><span class="command-prompt">$</span> _</div>
                `;
                
                addFreeModeLog("VPN配置已應用。", "success");
                addFreeModeLog(`配置詳情: ${encryption.toUpperCase()} 加密, ${protocol} 協議, 端口 ${port}`, "info");
                saveGameState();
            });
            
            // 模擬測試
            simulateBtn.addEventListener('click', function() {
                const simulationTest = document.getElementById('freeSimulationTest');
                simulationTest.style.display = 'block';
                simulationTest.scrollIntoView({ behavior: 'smooth' });
                addFreeModeLog("開啟模擬測試環境。", "info");
            });
            
            // 生成配置代碼
            generateBtn.addEventListener('click', function() {
                // 根據配置生成配置代碼
                let configCodeText = '';
                
                if (gameState.freeConfig.protocol.includes('wireguard')) {
                    configCodeText = `# WireGuard 配置文件
# 生成時間: ${new Date().toLocaleString('zh-TW')}

[Interface]
PrivateKey = YOUR_PRIVATE_KEY_HERE
Address = 10.0.0.2/24
DNS = 1.1.1.1, 1.0.0.1
${gameState.freeConfig.features.includes('killSwitch') ? 'PostUp = iptables -I OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT' : ''}
${gameState.freeConfig.features.includes('killSwitch') ? 'PreDown = iptables -D OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT' : ''}

[Peer]
PublicKey = SERVER_PUBLIC_KEY_HERE
Endpoint = vpn.example.com:${gameState.freeConfig.port}
AllowedIPs = 0.0.0.0/0
`;
                } else if (gameState.freeConfig.protocol.includes('openvpn')) {
                    configCodeText = `# OpenVPN 配置文件
# 生成時間: ${new Date().toLocaleString('zh-TW')}

# 客戶端配置
client
dev tun
proto ${gameState.freeConfig.protocol.includes('udp') ? 'udp' : 'tcp'}
remote vpn.example.com ${gameState.freeConfig.port}
resolv-retry infinite
nobind
persist-key
persist-tun

# 加密設置
cipher ${gameState.freeConfig.encryption.includes('aes') ? 'AES-256-GCM' : 'CHACHA20-POLY1305'}
auth SHA512
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384

# 認證設置
${gameState.freeConfig.authMethods.includes('password') ? 'auth-user-pass' : ''}
${gameState.freeConfig.authMethods.includes('certificate') ? 'ca ca.crt\ncert client.crt\nkey client.key' : ''}

# 安全設置
${gameState.freeConfig.features.includes('killSwitch') ? 'block-outside-dns' : ''}
${gameState.freeConfig.features.includes('dnsProtection') ? 'dhcp-option DNS 1.1.1.1\ndhcp-option DNS 1.0.0.1' : ''}

# 性能優化
compress lz4-v2
tun-mtu 1500
mssfix 1450

# 日誌設置
verb 3
`;
                } else {
                    configCodeText = `# VPN 配置文件
# 生成時間: ${new Date().toLocaleString('zh-TW')}
# 協議: ${gameState.freeConfig.protocol}
# 加密: ${gameState.freeConfig.encryption}
# 端口: ${gameState.freeConfig.port}

# 此配置需要根據具體VPN協議進行調整
# 請參考相應協議的文檔進行完整配置
`;
                }

                configCode.textContent = configCodeText;
                codeContainer.style.display = "block";
                codeContainer.scrollIntoView({ behavior: 'smooth' });
                addFreeModeLog("已生成VPN配置文件代碼。", "success");
            });
            
            // 複製配置代碼
            copyBtn.addEventListener('click', function() {
                const codeText = configCode.textContent;
                navigator.clipboard.writeText(codeText).then(() => {
                    addFreeModeLog("配置代碼已複製到剪貼板。", "success");
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> 已複製';
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i> 複製配置代碼';
                    }, 2000);
                }).catch(err => {
                    addFreeModeLog("複製失敗: " + err, "error");
                    alert('複製失敗，請手動選擇並複製代碼。');
                });
            });
            
            // 分享配置
            shareBtn.addEventListener('click', function() {
                const configText = configCode.textContent;
                if (!configText || configText.includes('等待配置命令')) {
                    alert('請先生成配置代碼再分享。');
                    return;
                }
                
                // 生成二維碼
                const canvas = document.getElementById('qrcodeCanvas');
                QRCode.toCanvas(canvas, configText, {
                    width: 200,
                    height: 200,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, function(error) {
                    if (error) {
                        console.error(error);
                        alert('生成二維碼失敗');
                    } else {
                        qrcodeContainer.classList.add('active');
                        qrcodeContainer.scrollIntoView({ behavior: 'smooth' });
                        addFreeModeLog("已生成配置分享二維碼。", "success");
                    }
                });
            });
            
            // 重置配置
            resetBtn.addEventListener('click', function() {
                document.getElementById('freeEncryptionSelect').value = 'aes-256';
                document.getElementById('freeEncryptionMode').value = 'gcm';
                document.getElementById('freeProtocolSelect').value = 'openvpn-udp';
                document.getElementById('freePortInput').value = '1194';
                
                document.getElementById('freeAuthPassword').checked = true;
                document.getElementById('freeAuthCertificate').checked = false;
                document.getElementById('freeAuth2FA').checked = false;
                document.getElementById('freeAuthOTP').checked = false;
                
                document.getElementById('freeKillSwitch').checked = true;
                document.getElementById('freeDNSProtection').checked = true;
                document.getElementById('freeNoLogs').checked = true;
                document.getElementById('freeIPv6Protection').checked = false;
                
                // 重置預設按鈕
                presetBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.preset-btn[data-preset="security"]').classList.add('active');
                
                gameState.freeConfig = {
                    encryption: 'aes-256',
                    encryptionMode: 'gcm',
                    protocol: 'openvpn-udp',
                    port: 1194,
                    authMethods: ['password'],
                    features: ['killSwitch', 'dnsProtection', 'noLogs']
                };
                
                configOutput.innerHTML = `
                    <div class="command-line"><span class="command-prompt">$</span> vpn-config --reset</div>
                    <div class="command-line" style="color: var(--success);">VPN配置已重置為默認值。</div>
                    <br>
                    <div class="command-line"><span class="command-prompt">$</span> _</div>
                `;
                
                codeContainer.style.display = "none";
                qrcodeContainer.classList.remove('active');
                document.getElementById('freeSimulationTest').style.display = 'none';
                
                addFreeModeLog("VPN配置已重置為默認值。", "info");
                saveGameState();
            });
            
            // 設置自由模式模擬測試
            setupFreeModeSimulationTest();
            
            // 初始化配置輸出
            configOutput.innerHTML = `
                <div class="command-line"><span class="command-prompt">$</span> vpn-config --help</div>
                <div class="command-line" style="color: #cbd5e1;">歡迎使用VPN配置工具</div>
                <div class="command-line" style="color: #cbd5e1;">可用的命令:</div>
                <div class="command-line" style="color: #cbd5e1;">  --apply     應用當前配置</div>
                <div class="command-line" style="color: #cbd5e1;">  --test      測試配置</div>
                <div class="command-line" style="color: #cbd5e1;">  --generate  生成配置代碼</div>
                <div class="command-line" style="color: #cbd5e1;">  --reset     重置配置</div>
                <br>
                <div class="command-line"><span class="command-prompt">$</span> _</div>
            `;
            
            // 重置配置
            resetBtn.click();
        }
        
        // 設置自由模式模擬測試
        function setupFreeModeSimulationTest() {
            const closeBtn = document.getElementById('freeCloseSimulation');
            const pingBtn = document.getElementById('freeRunPingTest');
            const speedBtn = document.getElementById('freeRunSpeedTest');
            const ipBtn = document.getElementById('freeCheckIP');
            const dnsBtn = document.getElementById('freeCheckDNS');
            const attackBtn = document.getElementById('freeSimulateAttack');
            const terminal = document.getElementById('freeTestTerminal');
            
            // 關閉測試
            closeBtn.addEventListener('click', function() {
                document.getElementById('freeSimulationTest').style.display = 'none';
                addFreeModeLog("關閉模擬測試環境。", "info");
            });
            
            // 清空終端
            function clearTerminal() {
                terminal.innerHTML = `
                    <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> 歡迎來到自由模式測試環境</div>
                    <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> 在這裡測試你的自定義VPN配置</div>
                    <br>
                    <div class="command-line"><span class="command-prompt">user@vpn-lab:~$</span> <input type="text" class="command-input" id="freeTestCommandInput" placeholder="輸入測試命令..."></div>
                `;
            }
            
            // 每次打開時清空終端
            document.getElementById('freeSimulateTestBtn').addEventListener('click', clearTerminal);
            
            // 測試連線
            pingBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-lab:~$</span> ping -c 4 8.8.8.8`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = 'PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=25.3 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=117 time=26.1 ms\n64 bytes from 8.8.8.8: icmp_seq=3 ttl=117 time=24.9 ms\n64 bytes from 8.8.8.8: icmp_seq=4 ttl=117 time=25.7 ms';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addFreeModeLog("Ping測試完成，連接正常。", "info");
            });
            
            // 速度測試
            speedBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-lab:~$</span> speedtest`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '下載速度: 85.2 Mbps\n上傳速度: 42.7 Mbps\n延遲: 25 ms\n抖動: 3 ms';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addFreeModeLog("速度測試完成，性能良好。", "info");
            });
            
            // 檢查IP
            ipBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-lab:~$</span> curl ifconfig.me`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = '203.0.113.45';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addFreeModeLog("IP地址檢查完成，VPN連接正常。", "info");
            });
            
            // 檢查DNS
            dnsBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-lab:~$</span> nslookup google.com`;
                terminal.appendChild(newLine);
                
                const result = document.createElement('div');
                result.className = 'command-line';
                result.style.color = '#cbd5e1';
                result.textContent = 'Server:     1.1.1.1\nAddress:    1.1.1.1#53\n\nNon-authoritative answer:\nName:   google.com\nAddress: 142.250.185.78';
                terminal.appendChild(result);
                
                terminal.scrollTop = terminal.scrollHeight;
                addFreeModeLog("DNS查詢測試完成，DNS保護正常。", "info");
            });
            
            // 模擬攻擊
            attackBtn.addEventListener('click', function() {
                const newLine = document.createElement('div');
                newLine.className = 'command-line';
                newLine.innerHTML = `<span class="command-prompt">user@vpn-lab:~$</span> security-test`;
                terminal.appendChild(newLine);
                
                const results = [
                    '開始安全測試...',
                    '1. DNS洩漏測試: 通過 ✓',
                    '2. WebRTC測試: 通過 ✓',
                    '3. 中間人攻擊測試: 防禦成功 ✓',
                    '4. 終止開關測試: 功能正常 ✓',
                    '5. 加密完整性測試: 通過 ✓',
                    '所有安全測試通過! 當前配置安全性優秀。'
                ];
                
                results.forEach(text => {
                    const result = document.createElement('div');
                    result.className = 'command-line';
                    result.style.color = text.includes('✓') ? 'var(--success)' : '#cbd5e1';
                    result.textContent = text;
                    terminal.appendChild(result);
                });
                
                terminal.scrollTop = terminal.scrollHeight;
                addFreeModeLog("完整安全測試完成，所有項目通過。", "success");
            });
        }
        
        // 添加日誌消息函數
        function addTutorialLogMessage(message, type = "info") {
            addLogMessage('tutorialMessageLog', message, type);
        }
        
        function addChallengeLogMessage(message, type = "info") {
            addLogMessage('challengeMessageLog', message, type);
        }
        
        function addFreeModeLog(message, type = "info") {
            addLogMessage('freeModeLog', message, type);
        }
        
        function addLogMessage(logId, message, type = "info") {
            const messageLog = document.getElementById(logId);
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            
            messageLog.appendChild(logEntry);
            messageLog.scrollTop = messageLog.scrollHeight;
        }
        
        // 初始化事件監聽
        function initEventListeners() {
            // 導航按鈕
            backBtn.addEventListener('click', goBack);
            homeBtn.addEventListener('click', () => showPage('homePage'));
            
            // 首頁模式選擇
            document.getElementById('tutorialMode').addEventListener('click', () => showPage('tutorialPage'));
            document.getElementById('challengeMode').addEventListener('click', () => showPage('challengePage'));
            document.getElementById('freeMode').addEventListener('click', () => showPage('freeModePage'));
            
            // 窗口大小變化時重新計算位置
            window.addEventListener('resize', function() {
                // 重新計算挑戰模式動畫位置
                if (gameState.currentPage === 'challengePage' && gameState.challenge.currentLevel === 1) {
                    const connectionLine = document.getElementById('challengeConnectionLine');
                    if (connectionLine && connectionLine.style.display === 'block') {
                        // 重新計算連接線位置
                        const clientRect = document.querySelector('#challengeLevel1Screen .client-node').getBoundingClientRect();
                        const serverRect = document.querySelector('#challengeLevel1Screen .server-node').getBoundingClientRect();
                        const gameRect = document.querySelector('.main-game').getBoundingClientRect();
                        
                        const startX = clientRect.left + clientRect.width/2 - gameRect.left;
                        const startY = clientRect.top + clientRect.height/2 - gameRect.top;
                        const endX = serverRect.left + serverRect.width/2 - gameRect.left;
                        const endY = serverRect.top + serverRect.height/2 - gameRect.top;
                        
                        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                        
                        connectionLine.style.width = `${length}px`;
                        connectionLine.style.left = `${startX}px`;
                        connectionLine.style.top = `${startY}px`;
                        connectionLine.style.transform = `rotate(${angle}deg)`;
                    }
                }
            });
        }
        
        // 初始化遊戲
        function initGame() {
            // 加載保存的遊戲狀態
            loadGameState();
            
            // 初始化事件監聽
            initEventListeners();
            updateNavButtons();
            
            // 初始化日誌
            addTutorialLogMessage("教學模式初始化完成。開始你的VPN學習之旅吧！", "info");
            addChallengeLogMessage("挑戰模式初始化完成。準備好接受挑戰了嗎？", "info");
            addFreeModeLog("自由模式初始化完成。開始實驗各種VPN配置吧！", "info");
            
            // 顯示保存狀態
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus && localStorage.getItem('vpnGameState')) {
                saveStatus.textContent = '已加載上次遊戲進度';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 3000);
            }
        }
        
        // 當頁面加載完成時初始化遊戲
        document.addEventListener('DOMContentLoaded', initGame);
        
        // 頁面卸載前保存狀態
        window.addEventListener('beforeunload', saveGameState);
        
        // 定期保存狀態
        setInterval(saveGameState, 30000); // 每30秒自動保存
    </script>
</body>
</html>